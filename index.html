<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Football Fantasy — NFL + NCAA (Tue→Mon · 3 picks)</title>
<style>
  :root{ --bg:#0b0d10; --card:#12161b; --muted:#8ea0b3; --text:#e8eef4; }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px 20px;border-bottom:1px solid #1e242c;background:#0f1318;position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:18px;letter-spacing:.3px}
  .sub{color:var(--muted);font-size:13px;margin-left:6px}
  nav.tabs{display:flex;gap:8px;padding:10px 20px;background:#0f1318;border-bottom:1px solid #1e242c;position:sticky;top:56px;z-index:9}
  .tab{padding:8px 12px;border:1px solid #243241;border-radius:10px;background:#111822;color:var(--text);cursor:pointer;font-size:13px}
  .tab[aria-selected="true"]{background:#162231;border-color:#31506a;font-weight:700}
  .section{display:none}
  .section.active{display:block}
  main{max-width:1200px;margin:0 auto;padding:16px 20px 40px}
  .card{background:var(--card);border:1px solid #1c222a;border-radius:14px;padding:16px}
  .sep{height:1px;background:#1a2129;margin:12px 0}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px}
  .btn.small{padding:6px 8px;font-size:12px}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .gamesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
  .gameCard{background:#11171e;border:1px solid #1f2a36;border-radius:14px;overflow:hidden}
  .band{height:6px}
  .gameBody{padding:12px}
  .teamsRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .team{display:flex;align-items:center;gap:8px;min-width:0}
  .team img{width:26px;height:26px;border-radius:6px;border:1px solid #1e2732;background:#0f1318}
  .team .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .lockRow{display:flex;gap:8px;margin-top:10px}
  .assignWrap{display:flex;gap:6px;align-items:center;margin-top:8px}
  .disabledNote{margin-top:6px;font-size:12px;color:#c78}
  .topGrid{display:grid;grid-template-columns:1fr 260px 260px;gap:14px;align-items:start}
  @media(max-width:980px){.topGrid{grid-template-columns:1fr}}
  .teamline{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:12px;background:#0f1318;border:1px solid #1c2430}
  .teamline img{width:28px;height:28px;border-radius:6px;border:1px solid #1e2732;background:#0d1218}
  .statusBox,.scoreBox{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:12px}
  .scoreBox{text-align:center}
  .scoreBox .num{font-size:42px;font-weight:900}
  .contentGrid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:1060px){.contentGrid{grid-template-columns:1fr}}
  .log{max-height:260px;overflow:auto;background:#0f1318;border-radius:10px;padding:8px;border:1px solid #1b232d}
  .lbHeaderRow{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .lbRow{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:8px;border-radius:10px;border:1px solid #1c2430;background:#0f1318;margin-bottom:8px;cursor:pointer}
  .lbTeam{display:flex;gap:8px;align-items:center;min-width:0}
  .lbTeam img{width:20px;height:20px;border-radius:4px;border:1px solid #1c2330;background:#0d1218}
  .lbName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .scoreTag{display:inline-block;margin-left:6px;padding:2px 6px;border:1px solid #26313c;border-radius:6px;font-weight:700}
  .lbPts{font-weight:700}
  .lbMeta{font-size:12px;color:var(--muted)}
  .panel{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:12px}
  .field{display:flex;gap:8px;margin-top:8px}
  input[type="text"]{flex:1;background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:8px}
  select{background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:8px}
  .pickBadge{display:inline-block;margin-left:8px;padding:2px 6px;border:1px solid #26313c;border-radius:8px;font-size:12px}
  .collapsed .playersContent{display:none}
  .playersToggle[aria-expanded="false"]::after{content:"  ▸"}
  .playersToggle[aria-expanded="true"]::after{content:"  ▾"}
  .warn{color:#ffb070}
</style>
</head>
<body>
<header>
  <h1>Football Fantasy — <span class="sub">NFL & NCAA · Tue→Mon · 3 picks · AI bots</span></h1>
</header>

<nav class="tabs" role="tablist" aria-label="Leagues">
  <button id="tab-nfl" class="tab" role="tab" aria-controls="sec-nfl" aria-selected="true">NFL</button>
  <button id="tab-ncaaf" class="tab" role="tab" aria-controls="sec-ncaaf" aria-selected="false">NCAA (FBS)</button>
</nav>

<!-- NFL -->
<section id="sec-nfl" class="section active" aria-labelledby="tab-nfl">
  <main>
    <div id="nfl-top" class="card" style="display:none">
      <div class="small" id="nfl-liveHeader">—</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0">
        <button id="nfl-backBtn" class="btn small" style="display:none">← Back to games</button>
        <select id="nfl-playerSelect" class="btn small" style="min-width:160px"></select>
        <button id="nfl-addPickBtn" class="btn small">Add to my picks</button>
        <span id="nfl-picksLeft" class="small" style="opacity:.85"></span>
        <span class="small" style="margin-left:10px;opacity:.8">Jump:</span>
        <select id="nfl-jump" class="btn small" style="min-width:260px;max-width:60vw"></select>
        <button id="nfl-jumpBtn" class="btn small">View</button>
      </div>
      <div class="topGrid">
        <div id="nfl-teamSide"></div>
        <div class="scoreBox">
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Fantasy Score</div>
          <div id="nfl-fscore" class="num">—</div>
          <div id="nfl-flow" class="small"></div>
        </div>
        <div class="statusBox">
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Game Status</div>
          <div class="small">Clock: <span id="nfl-clock" class="small" style="font-weight:700">—</span></div>
          <div class="small">Quarter: <span id="nfl-q" class="small" style="font-weight:700">—</span></div>
          <div class="small">State: <span id="nfl-state" class="small" style="font-weight:700">—</span></div>
        </div>
      </div>
    </div>

    <section id="nfl-splash" class="card">
      <div id="nfl-weekNote" class="small">Loading…</div>
      <div class="sep"></div>

      <div id="nfl-playersWrap" class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div><strong>Players</strong> <span class="small">(local)</span> <span class="pickBadge">Pick 3 per week</span></div>
          <button id="nfl-playersToggle" class="btn small playersToggle" aria-expanded="true" aria-controls="nfl-playersContent">Collapse</button>
        </div>
        <div id="nfl-playersContent" class="playersContent" style="margin-top:8px">
          <div class="field">
            <input id="nfl-newPlayer" type="text" placeholder="Add player name">
            <button id="nfl-addPlayer" class="btn small">Add</button>
            <button id="nfl-clearWeek" class="btn small" title="Clear only this week">Clear Week</button>
          </div>
          <div id="nfl-playersPanel" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="sep"></div>
      <div id="nfl-gridNote" class="small">—</div>
      <div id="nfl-grid" class="gamesGrid"></div>
    </section>

    <section id="nfl-tracker" style="display:none">
      <div class="contentGrid">
        <section class="card">
          <div class="lbHeaderRow">
            <h2 style="margin:0">Games Leaderboard (Top 10)</h2>
            <button id="nfl-toggleAll" class="btn small" aria-expanded="false">Show all</button>
          </div>
          <div id="nfl-lb"></div>
        </section>
        <section class="card">
          <div class="lbHeaderRow">
            <h2 style="margin:0">Players — This Week</h2>
          </div>
          <div id="nfl-pLB"></div>
          <div class="sep"></div>
          <div class="lbHeaderRow">
            <h2 style="margin:0">Players — Season</h2>
          </div>
          <div id="nfl-pSeason"></div>
          <div class="sep"></div>
          <h3 style="margin:0 0 6px 0">Scoring Plays</h3>
          <div id="nfl-log" class="log"></div>
        </section>
      </div>
    </section>
  </main>
</section>

<!-- NCAA -->
<section id="sec-ncaaf" class="section" aria-labelledby="tab-ncaaf">
  <main>
    <div id="ncaaf-top" class="card" style="display:none">
      <div class="small" id="ncaaf-liveHeader">—</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0">
        <button id="ncaaf-backBtn" class="btn small" style="display:none">← Back to games</button>
        <select id="ncaaf-playerSelect" class="btn small" style="min-width:160px"></select>
        <button id="ncaaf-addPickBtn" class="btn small">Add to my picks</button>
        <span id="ncaaf-picksLeft" class="small" style="opacity:.85"></span>
        <span class="small" style="margin-left:10px;opacity:.8">Jump:</span>
        <select id="ncaaf-jump" class="btn small" style="min-width:260px;max-width:60vw"></select>
        <button id="ncaaf-jumpBtn" class="btn small">View</button>
      </div>
      <div class="topGrid">
        <div id="ncaaf-teamSide"></div>
        <div class="scoreBox">
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Fantasy Score</div>
          <div id="ncaaf-fscore" class="num">—</div>
          <div id="ncaaf-flow" class="small"></div>
        </div>
        <div class="statusBox">
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Game Status</div>
          <div class="small">Clock: <span id="ncaaf-clock" class="small" style="font-weight:700">—</span></div>
          <div class="small">Quarter: <span id="ncaaf-q" class="small" style="font-weight:700">—</span></div>
          <div class="small">State: <span id="ncaaf-state" class="small" style="font-weight:700">—</span></div>
        </div>
      </div>
    </div>

    <section id="ncaaf-splash" class="card">
      <div id="ncaaf-weekNote" class="small">Loading…</div>
      <div class="sep"></div>

      <div id="ncaaf-playersWrap" class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div><strong>Players</strong> <span class="small">(local)</span> <span class="pickBadge">Pick 3 per week</span></div>
          <button id="ncaaf-playersToggle" class="btn small playersToggle" aria-expanded="true" aria-controls="ncaaf-playersContent">Collapse</button>
        </div>
        <div id="ncaaf-playersContent" class="playersContent" style="margin-top:8px">
          <div class="field">
            <input id="ncaaf-newPlayer" type="text" placeholder="Add player name">
            <button id="ncaaf-addPlayer" class="btn small">Add</button>
            <button id="ncaaf-clearWeek" class="btn small" title="Clear only this week">Clear Week</button>
          </div>
          <div id="ncaaf-playersPanel" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="sep"></div>
      <div id="ncaaf-gridNote" class="small">—</div>
      <div id="ncaaf-grid" class="gamesGrid"></div>
    </section>

    <section id="ncaaf-tracker" style="display:none">
      <div class="contentGrid">
        <section class="card">
          <div class="lbHeaderRow">
            <h2 style="margin:0">Games Leaderboard (Top 10)</h2>
            <button id="ncaaf-toggleAll" class="btn small" aria-expanded="false">Show all</button>
          </div>
          <div id="ncaaf-lb"></div>
        </section>
        <section class="card">
          <div class="lbHeaderRow">
            <h2 style="margin:0">Players — This Week</h2>
          </div>
          <div id="ncaaf-pLB"></div>
          <div class="sep"></div>
          <div class="lbHeaderRow">
            <h2 style="margin:0">Players — Season</h2>
          </div>
          <div id="ncaaf-pSeason"></div>
          <div class="sep"></div>
          <h3 style="margin:0 0 6px 0">Scoring Plays</h3>
          <div id="ncaaf-log" class="log"></div>
        </section>
      </div>
    </section>
  </main>
</section>

<script>
/* ===== Constants & utilities ===== */
var TZ = 'America/New_York';
var POLL_MS = 15000;
var LB_POLL_MS = 45000;
var GRID_POLL_MS = 20000;
var SPREAD_LIMIT = 30;
var INCLUDE_UNKNOWN_SPREADS = true;
var PICKS_REQUIRED = 3;
var W = { TD:3, FG:2, XP:0.5, TWO:1, YARD:0.05, FIRST_DOWN:0.5, SACK:2.5, TFL:1.5, INT:5.5, FR:5, DEF_TD_BONUS:3, SAFETY:6, STOP:2, ST_RETURN_TD:8, BLOCK:5, CLOSE_GAME:10, OVERTIME:15 };
var AI_COUNT = 25;
var BOT_PREFIX = 'ai-';
var AI_NAMES = ['GridironBot','BlitzBrain','PocketOracle','HailMaryAI','TwoMinuteDrill','ChainMover','RedZoneRobo','SnapCount','NeutralZone','DriveEngine','TurfWizard','SidelineSynth','YACMachine','PlaybookGPT','NickelNerd','SafetyValve','SkyKick','GoalLineGolem','BoothReview','AudibleAI','TempoTactician','OptionOverlord','HotRoute','EdgeRusher','FieldGeneral'];

function nowEST(){ return new Date(new Date().toLocaleString('en-US',{timeZone:TZ})); }
function addDaysEST(d,days){ var n=new Date(d.getTime()); n.setDate(n.getDate()+days); return new Date(n.toLocaleString('en-US',{timeZone:TZ})); }
function fmtParts(d,opts){ var parts=new Intl.DateTimeFormat('en-US',opts).formatToParts(d); var o={}; for(var i=0;i<parts.length;i++){ o[parts[i].type]=parts[i].value; } return o; }
function fmtDateStr(d){ return d.split('-').join(''); }
function timeout(ms){ return new Promise(function(r){ setTimeout(r,ms); }); }
async function safeFetch(url,opts,retries){
  var r = typeof retries==='number' ? retries : 2;
  for(var i=0;i<=r;i++){
    try{
      var ctl = new AbortController();
      var t = setTimeout(function(){ctl.abort();},15000);
      var res = await fetch(url, Object.assign({}, opts||{}, {signal:ctl.signal}));
      clearTimeout(t);
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }catch(e){
      if(i===r) throw e; await timeout(600*(i+1));
    }
  }
}

/* Auto-reload when week flips */
(function(){
  var current = weekKey();
  setInterval(function(){
    var wk = weekKey();
    if (wk !== current) location.reload();
  }, 60000);
})();

/* Week window (Tue→Mon) */
function weekKey(){
  var n=nowEST();
  var wd=n.getDay();
  var daysSinceTue=(wd-2+7)%7;
  var tue=addDaysEST(n,-daysSinceTue);
  var p=fmtParts(n,{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
  var after8 = Number(p.hour)>=8 || daysSinceTue>0;
  var anchor = after8 ? tue : addDaysEST(tue,-7);
  var k=fmtParts(anchor,{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'});
  return k.year+'-'+k.month+'-'+k.day+'-Tue08ET';
}
function weekDateList(){
  var n=nowEST(); var wd=n.getDay(); var daysSinceTue=(wd-2+7)%7; var tue=addDaysEST(n,-daysSinceTue);
  var dates=[]; for(var i=0;i<7;i++){ var d=addDaysEST(tue,i); var p=fmtParts(d,{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}); dates.push(p.year+'-'+p.month+'-'+p.day); }
  var pTue=fmtParts(tue,{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'}); var mon=addDaysEST(tue,6); var pMon=fmtParts(mon,{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'});
  return { start: dates[0], end: dates[6], list: dates, pretty: (pTue.month+'/'+pTue.day+' → '+pMon.month+'/'+pMon.day) };
}

/* Logos */
function cdnNFL(t){
  if(!t) return null;
  if(t.logos && t.logos[0] && t.logos[0].href) return String(t.logos[0].href).replace(/^http:/,'https:');
  if(t.abbreviation) return 'https://a.espncdn.com/i/teamlogos/nfl/500/'+t.abbreviation+'.png';
  return null;
}
function cdnNCAAF(t){
  if(!t) return null;
  if(t.logos && t.logos[0] && t.logos[0].href) return String(t.logos[0].href).replace(/^http:/,'https:');
  if(t.id) return 'https://a.espncdn.com/i/teamlogos/ncaa/500/'+t.id+'.png';
  if(t.abbreviation) return 'https://a.espncdn.com/i/teamlogos/ncaa/500/'+t.abbreviation+'.png';
  return null;
}

/* ===== League Factory ===== */
function createLeague(config){
  var state = {
    selected: null,
    players: [],
    picks: {},
    weeklyEvents: [],
    started: new Set(),
    lastScoring: new Set(),
    gameScoreCache: new Map(),
    lbRows: [],
    showAll: false,
    pollTimer: null,
    lbTimer: null,
    gridTimer: null
  };
  var WK = weekKey();

  /* Storage */
  function load(key,def){ try{ var v=localStorage.getItem(config.prefix+'.'+key); return v?JSON.parse(v):def; }catch(e){ return def; } }
  function save(key,val){ localStorage.setItem(config.prefix+'.'+key, JSON.stringify(val)); }

  /* DOM */
  var N = config.nodes;

  /* Players & AI */
  function isBot(p){ return p && typeof p.id==='string' && p.id.indexOf(BOT_PREFIX)===0; }
  function ensureAI(){
    var have=new Set(); for(var i=0;i<state.players.length;i++){ if(isBot(state.players[i])) have.add(state.players[i].name); }
    for(var j=0;j<AI_COUNT && j<AI_NAMES.length;j++){
      var nm=AI_NAMES[j]; if(!have.has(nm)){ state.players.push({id: BOT_PREFIX+Math.random().toString(36).slice(2,9), name: nm}); }
    }
  }
  function currentPlayerId(){ return N.playerSelect.value || (state.players[0] ? state.players[0].id : null); }
  function picksFor(pid){ if(!state.picks[WK]) state.picks[WK]={}; if(!state.picks[WK][pid]) state.picks[WK][pid]={gameIds:[], lockedAt:new Date().toISOString()}; return state.picks[WK][pid]; }
  function picksCount(pid){ return picksFor(pid).gameIds.length; }
  function updatePicksLeft(){
    var pid=currentPlayerId(); if(!pid){ N.picksLeft.textContent=''; return; }
    var left = PICKS_REQUIRED - picksCount(pid); if(left<0) left=0;
    N.picksLeft.textContent = String(left)+' pick'+(left===1?'':'s')+' left this week';
  }
  function refreshPlayerSelect(){
    N.playerSelect.innerHTML='';
    for(var i=0;i<state.players.length;i++){
      var p=state.players[i]; var o=document.createElement('option'); o.value=p.id; o.textContent=isBot(p)?(p.name+' (AI)'):p.name; N.playerSelect.appendChild(o);
    }
    updatePicksLeft();
  }
  function renderPlayersPanel(){
    var panel=N.playersPanel; panel.innerHTML='';
    if(state.players.length===0){ panel.innerHTML='<div class="small">No players yet. Add some above.</div>'; refreshPlayerSelect(); return; }
    for(var i=0;i<state.players.length;i++){
      var p=state.players[i]; var wk=picksFor(p.id); var labs=wk.gameIds.map(function(id){return shortLabel(id);}).join(' · ');
      var wrap=document.createElement('div');
      wrap.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid #1c2430;background:#0f1318;padding:8px;border-radius:10px;margin-bottom:8px';
      var badge = ' <span class="pickBadge">'+wk.gameIds.length+'/'+PICKS_REQUIRED+'</span>';
      wrap.innerHTML='<div><strong>'+p.name+'</strong>'+(isBot(p)?' <span class="small" style="opacity:.8">(AI)</span>':'')+badge+'<div class="small" style="opacity:.8">'+(labs|| (isBot(p)?'AI will auto-pick':'No picks yet'))+'</div></div><div><button class="btn small" data-del="'+p.id+'">Del</button></div>';
      panel.appendChild(wrap);
    }
    panel.querySelectorAll('[data-del]').forEach(function(b){
      b.addEventListener('click', function(){
        var id=b.getAttribute('data-del');
        state.players = state.players.filter(function(x){ return x.id!==id; });
        var weeks=Object.keys(state.picks);
        for(var k=0;k<weeks.length;k++){ var wkKey=weeks[k]; if(state.picks[wkKey] && state.picks[wkKey][id]) delete state.picks[wkKey][id]; }
        save('players',state.players); save('picks',state.picks);
        renderPlayersPanel(); refreshPlayerSelect();
      });
    });
    refreshPlayerSelect();
  }
  N.addPlayer.addEventListener('click',function(){
    var name=(N.newPlayer.value||'').trim(); if(!name) return;
    state.players.push({id:'p'+Math.random().toString(36).slice(2,9), name:name}); N.newPlayer.value='';
    save('players',state.players); renderPlayersPanel(); refreshPlayerSelect();
  });
  N.clearWeek.addEventListener('click',function(){
    state.picks[WK]={}; save('picks',state.picks); renderPlayersPanel(); updatePicksLeft(); renderPlayersLB(); renderSeasonLB();
  });
  N.playersToggle.addEventListener('click',function(){
    var open=N.playersToggle.getAttribute('aria-expanded')==='true';
    if(open){ N.playersWrap.classList.add('collapsed'); N.playersToggle.setAttribute('aria-expanded','false'); N.playersToggle.textContent='Expand'; }
    else{ N.playersWrap.classList.remove('collapsed'); N.playersToggle.setAttribute('aria-expanded','true'); N.playersToggle.textContent='Collapse'; }
  });

  function isLocked(g){
    try{
      if(state.started.has(g.id)) return true;
      var now=nowEST().getTime();
      var kick=new Date(g.start).getTime();
      if(now>=kick){ state.started.add(g.id); return true; }
      return false;
    }catch(e){ return false; }
  }

  /* AI */
  function aiScore(g){
    var spread = g.spread===null || typeof g.spread==='undefined' ? 8 : Math.abs(Number(g.spread)||8);
    var closeness = 10 - Math.min(spread,10);
    var rnd=(Math.random()-0.5)*0.7;
    return closeness + rnd;
  }
  function ensureAIPicks(){
    var ai=state.players.filter(function(p){return isBot(p);});
    if(ai.length===0) return;
    var ranked = state.weeklyEvents.filter(function(g){return !isLocked(g);}).map(function(g){
      return {id:g.id, score:aiScore(g)};
    }).sort(function(a,b){return b.score-a.score;});
    for(var i=0;i<ai.length;i++){
      var wk=picksFor(ai[i].id);
      var idx=0;
      while(wk.gameIds.length<PICKS_REQUIRED && idx<ranked.length){
        var gid=ranked[idx].id;
        if(wk.gameIds.indexOf(gid)===-1) wk.gameIds.push(gid);
        idx++;
      }
    }
    save('picks',state.picks);
  }

  /* Labels */
  function shortLabel(eventId){
    for(var i=0;i<state.weeklyEvents.length;i++){
      var g=state.weeklyEvents[i]; if(g.id===eventId){ return g.away.name+' @ '+g.home.name; }
    }
    return '#'+eventId;
  }

  /* Fetchers */
  function apiScoreboard(dateStr){ return safeFetch(config.endpoints.scoreboard+fmtDateStr(dateStr)); }
  function apiOdds(eventId){ return safeFetch(config.endpoints.odds(eventId)); }
  function apiSummary(eventId){ return safeFetch(config.endpoints.summary+eventId); }
  function apiBox(eventId){ return safeFetch(config.endpoints.box+eventId); }
  function apiPbp(eventId){ return safeFetch(config.endpoints.pbp+eventId); }

  /* UI toggles */
  function showTop(on){ N.top.style.display = on ? 'block' : 'none'; }
  function showSplash(on){ N.splash.style.display = on ? 'block' : 'none'; }
  function showTracker(on){ N.tracker.style.display = on ? 'block' : 'none'; }

  function goToGrid(){
    showTop(false); showTracker(false); showSplash(true);
    var bb=document.getElementById(config.ids.backBtn); if(bb) bb.style.display='none';
    state.selected=null; if(state.pollTimer){ clearInterval(state.pollTimer); state.pollTimer=null; }
  }
  function wireBack(){
    var bb=document.getElementById(config.ids.backBtn); if(!bb) return;
    bb.addEventListener('click', goToGrid);
  }

  /* Grid render */
  function renderGrid(list){
    N.grid.innerHTML='';
    for(var i=0;i<list.length;i++){
      var g=list[i];
      var band='linear-gradient(90deg,'+(g.away.color?('#'+g.away.color):'#1a232d')+' 0%,'+(g.home.color?('#'+g.home.color):'#26313c')+' 100%)';
      var card=document.createElement('div'); card.className='gameCard';
      var started=isLocked(g);
      var kickoff=new Date(g.start).toLocaleString([], {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'2-digit'});
      var liveRow = '<div class="small" style="margin-top:6px;opacity:.9">Score: <span id="'+config.prefix+'-scr-'+g.id+'">—</span> &middot; <span id="'+config.prefix+'-st-'+g.id+'">pre</span> &middot; Spread: '+(g.spread===null?'—':Number(g.spread).toFixed(1))+' &middot; Kick: '+kickoff+'</div>';

      card.innerHTML =
        '<div class="band" style="background:'+band+'"></div>'+
        '<div class="gameBody">'+
          '<div class="teamsRow">'+
            '<div class="team">'+(g.away.logo?('<img src="'+g.away.logo+'" alt="">'):'')+'<div class="name">'+g.away.name+'</div></div>'+
            '<div class="small" style="opacity:.8">@</div>'+
            '<div class="team" style="justify-content:flex-end">'+(g.home.logo?('<img src="'+g.home.logo+'" alt="">'):'')+'<div class="name">'+g.home.name+'</div></div>'+
          '</div>'+
          liveRow+
          '<div class="lockRow">'+
            '<button class="btn lockBtn" '+(started?'disabled':'')+'>🔒 Add to pick</button>'+
            '<button class="btn small viewBtn">Open</button>'+
          '</div>'+
          '<div class="assignWrap">'+
            '<select class="assignSel"><option value="">Assign to player…</option></select>'+
            '<button class="btn small assignBtn" '+(started?'disabled':'')+'>Assign</button>'+
          '</div>'+
          (started?'<div class="disabledNote">Locked (already started)</div>':'')+
        '</div>';

      var sel=card.querySelector('.assignSel');
      for(var p=0;p<state.players.length;p++){
        var pl=state.players[p]; var o=document.createElement('option'); o.value=pl.id; o.textContent=isBot(pl)?(pl.name+' (AI)'):pl.name; sel.appendChild(o);
      }

      card.querySelector('.viewBtn').addEventListener('click', function(gcopy){ return function(){ openGame(gcopy); }; }(g));
      card.querySelector('.lockBtn').addEventListener('click', function(gcopy){ return function(){
        if(isLocked(gcopy)) return;
        var pid=currentPlayerId(); if(!pid){ alert('Add/select a player first.'); return; }
        var wk=picksFor(pid);
        if(wk.gameIds.indexOf(gcopy.id)!==-1){ alert('Already picked.'); return; }
        if(wk.gameIds.length>=PICKS_REQUIRED){ alert('You already have '+PICKS_REQUIRED+' picks.'); return; }
        wk.gameIds.push(gcopy.id); save('picks',state.picks); updatePicksLeft(); renderPlayersPanel(); renderPlayersLB(); renderSeasonLB();
      }; }(g));
      card.querySelector('.assignBtn').addEventListener('click', function(gcopy, selEl){ return function(){
        var pid=selEl.value; if(!pid) return;
        if(isLocked(gcopy)) return;
        var wk=picksFor(pid);
        if(wk.gameIds.indexOf(gcopy.id)!==-1){ alert('Already picked.'); selEl.value=''; return; }
        if(wk.gameIds.length>=PICKS_REQUIRED){ alert('Player already has '+PICKS_REQUIRED+' picks.'); selEl.value=''; return; }
        wk.gameIds.push(gcopy.id); save('picks',state.picks); selEl.value=''; renderPlayersPanel(); renderPlayersLB(); renderSeasonLB();
      }; }(g, sel));

      N.grid.appendChild(card);
    }
  }

  function fillJump(){
    N.jump.innerHTML='';
    var items=state.weeklyEvents.slice().sort(function(a,b){ return new Date(a.start)-new Date(b.start); });
    for(var i=0;i<items.length;i++){
      var g=items[i];
      var o=document.createElement('option');
      var when=new Date(g.start).toLocaleString([], {weekday:'short', hour:'numeric', minute:'2-digit'});
      o.value=g.id; o.textContent=when+' — '+g.away.name+' @ '+g.home.name;
      N.jump.appendChild(o);
    }
  }
  N.jumpBtn.addEventListener('click',function(){
    var id=N.jump.value; var g=null;
    for(var i=0;i<state.weeklyEvents.length;i++){ if(state.weeklyEvents[i].id===id){ g=state.weeklyEvents[i]; break; } }
    if(g) openGame(g);
  });

  function openGame(g){
    state.selected=g;
    N.liveHeader.textContent = g.away.name+' @ '+g.home.name+(g.spread===null?'':(' (spread '+Number(g.spread).toFixed(1)+')'));
    N.teamSide.innerHTML =
      '<div class="teamline" style="border-left:6px solid '+(g.away.color?('#'+g.away.color):'#2a3643')+'">'+
        '<div style="display:flex;gap:10px;align-items:center">'+(g.away.logo?('<img src="'+g.away.logo+'" alt="">'):'')+'<div style="font-weight:700">'+g.away.name+'</div></div>'+
        '<div id="'+config.ids.awayScore+'" style="font-weight:800">—</div>'+
      '</div>'+
      '<div class="teamline" style="border-left:6px solid '+(g.home.color?('#'+g.home.color):'#2a3643')+'">'+
        '<div style="display:flex;gap:10px;align-items:center">'+(g.home.logo?('<img src="'+g.home.logo+'" alt="">'):'')+'<div style="font-weight:700">'+g.home.name+'</div></div>'+
        '<div id="'+config.ids.homeScore+'" style="font-weight:800">—</div>'+
      '</div>';

    showTop(true); showSplash(false); showTracker(true);
    var bb=document.getElementById(config.ids.backBtn); if(bb) bb.style.display='inline-block';
    if(state.pollTimer) clearInterval(state.pollTimer);
    refreshOnce();
    state.pollTimer=setInterval(function(){ if(sectionVisible(config.sectionId)) refreshOnce(); }, POLL_MS);
    fillJump();
    updatePicksLeft();
  }

  function sectionVisible(id){
    var sec=document.getElementById(id);
    return !!sec && sec.classList.contains('active');
  }

  /* Data loading */
  async function loadWeek(){
    N.grid.innerHTML=''; N.weekNote.textContent='Loading week…';
    if(state.pollTimer) clearInterval(state.pollTimer);
    if(state.lbTimer) clearInterval(state.lbTimer);
    if(state.gridTimer) clearInterval(state.gridTimer);
    state.lastScoring.clear(); state.weeklyEvents=[]; state.started=new Set();

    var range=weekDateList();
    var scoreboards = [];
    for(var i=0;i<range.list.length;i++){
      var d=range.list[i];
      var sb = await apiScoreboard(d);
      scoreboards.push(sb);
    }

    var ids=new Set(); var base=[];
    for(var s=0;s<scoreboards.length;s++){
      var evs = scoreboards[s] && scoreboards[s].events ? scoreboards[s].events : [];
      for(var e=0;e<evs.length;e++){
        var ev=evs[e];
        if(ids.has(ev.id)) continue;
        ids.add(ev.id);
        var comp = ev.competitions && ev.competitions[0] ? ev.competitions[0] : {};
        var cs = comp.competitors || [];
        var home = null, away = null;
        for(var c=0;c<cs.length;c++){ if(cs[c].homeAway==='home') home=cs[c]; if(cs[c].homeAway==='away') away=cs[c]; }
        var stateStr = (comp.status && comp.status.type && comp.status.type.state) ? comp.status.type.state : 'pre';
        if(stateStr!=='pre') state.started.add(ev.id);
        base.push({
          id: ev.id,
          competitionId: comp.id ? comp.id : ev.id,
          dateISO: range.list[s],
          start: ev.date,
          state: stateStr,
          home: { name: (home && home.team && (home.team.shortDisplayName || home.team.displayName)) ? (home.team.shortDisplayName || home.team.displayName) : 'Home', id: home && home.team ? home.team.id : null, abbr: home && home.team ? (home.team.abbreviation || '') : '', logo: config.logo(home && home.team ? home.team : null), color: home && home.team && home.team.color ? home.team.color : null },
          away: { name: (away && away.team && (away.team.shortDisplayName || away.team.displayName)) ? (away.team.shortDisplayName || away.team.displayName) : 'Away', id: away && away.team ? away.team.id : null, abbr: away && away.team ? (away.team.abbreviation || '') : '', logo: config.logo(away && away.team ? away.team : null), color: away && away.team && away.team.color ? away.team.color : null }
        });
      }
    }

    if(base.length===0){ N.weekNote.textContent='No games found for this window.'; return; }

    var withSpreads=[];
    for(var g=0; g<base.length; g++){
      var gg=base[g]; var spread = null;
      try{
        var idx=await apiOdds(gg.id);
        if(idx && idx.items && idx.items.length>0){
          var ref = idx.items[0].$ref || idx.items[0].href || null;
          if(ref){
            var od=await safeFetch(ref);
            var val=null;
            if(od && od.details && typeof od.details.spread!=='undefined') val=Number(od.details.spread);
            else if(od && typeof od.spread!=='undefined') val=Number(od.spread);
            else if(od && od.awayTeamOdds && typeof od.awayTeamOdds.spread!=='undefined') val=Number(od.awayTeamOdds.spread);
            else if(od && od.homeTeamOdds && typeof od.homeTeamOdds.spread!=='undefined') val=Number(od.homeTeamOdds.spread);
            if(val!==null && !isNaN(val)) spread=Math.abs(val);
          }
        }
      }catch(e){}
      withSpreads.push({ id: gg.id, competitionId: gg.competitionId, dateISO: gg.dateISO, start: gg.start, state: gg.state, home: gg.home, away: gg.away, spread: spread });
    }

    var eligible = withSpreads.filter(function(gm){ return gm.spread===null ? INCLUDE_UNKNOWN_SPREADS : (gm.spread<=SPREAD_LIMIT); });
    eligible.sort(function(a,b){ return new Date(a.start)-new Date(b.start); });
    state.weeklyEvents = eligible;

    N.gridNote.textContent = 'Showing '+config.label+' games for '+range.start+' → '+range.end+' (Tue→Mon '+range.pretty+') · spread ≤ '+SPREAD_LIMIT+(INCLUDE_UNKNOWN_SPREADS?' · unknown spreads included':'')+'.';
    N.weekNote.textContent = eligible.length+' eligible game'+(eligible.length===1?'':'s');
    renderGrid(eligible);
    fillJump();

    ensureAI(); save('players',state.players); renderPlayersPanel();
    ensureAIPicks(); save('picks',state.picks);

    startGridPolling();
    refreshLB();
    if(state.lbTimer) clearInterval(state.lbTimer);
    state.lbTimer=setInterval(function(){ if(sectionVisible(config.sectionId)) refreshLB(); }, LB_POLL_MS);
  }

  async function refreshGridScores(){
    if (!state.weeklyEvents || state.weeklyEvents.length === 0) return;
    try {
      var batch = state.weeklyEvents; // all is fine; computeRow uses caches
      for (var i = 0; i < batch.length; i++) {
        var ev = batch[i];
        var row = await computeRow(ev.id);
        var scEl = document.getElementById(config.prefix+'-scr-'+ev.id);
        var stEl = document.getElementById(config.prefix+'-st-'+ev.id);
        if (row && scEl && stEl) {
          scEl.textContent = row.awayPts + '–' + row.homePts;
          stEl.textContent = row.status || '—';
        }
      }
    } catch (e) {}
  }
  function startGridPolling(){
    refreshGridScores();
    if (state.gridTimer) clearInterval(state.gridTimer);
    state.gridTimer = setInterval(refreshGridScores, GRID_POLL_MS);
  }

  /* Scoring helpers */
  function sumStatsFromSummary(summary){
    var totals={ yards:0, firstDowns:0, tfl:0, sacks:0, thirdMade:0, thirdAtt:0, fourthMade:0, fourthAtt:0, safeties:0 };
    var teams = summary && summary.boxscore && summary.boxscore.teams ? summary.boxscore.teams : [];
    function add(statArr, keyName){
      for(var i=0;i<statArr.length;i++){ if(statArr[i].name===keyName || statArr[i].abbreviation===keyName) return statArr[i]; }
      return null;
    }
    for(var t=0;t<teams.length;t++){
      var st = teams[t].statistics || [];
      var ry=add(st,'rushingYards'); var py=add(st,'netPassingYards');
      var ryv = ry ? Number(ry.value || ry.displayValue || 0) : 0;
      var pyv = py ? Number(py.value || py.displayValue || 0) : 0;
      totals.yards += (isNaN(ryv)?0:ryv) + (isNaN(pyv)?0:pyv);
      var fd=add(st,'firstDowns'); totals.firstDowns += fd ? Number(fd.value || fd.displayValue || 0) : 0;
      var sa=add(st,'sacks'); 
      var sval=0; if(sa){ var dv=String(sa.displayValue||'').split('-')[0]; sval = sa.value ? Number(sa.value) : Number(dv); if(isNaN(sval)) sval=0; }
      totals.sacks += sval;
      var tfl=add(st,'tacklesForLoss'); totals.tfl += tfl ? Number(tfl.value || tfl.displayValue || 0) : 0;
      var th=add(st,'thirdDownEff'); var thv = th ? String(th.displayValue||'0-0').split('-') : ['0','0']; totals.thirdMade+=Number(thv[0]||0); totals.thirdAtt+=Number(thv[1]||0);
      var fh=add(st,'fourthDownEff'); var fhv = fh ? String(fh.displayValue||'0-0').split('-') : ['0','0']; totals.fourthMade+=Number(fhv[0]||0); totals.fourthAtt+=Number(fhv[1]||0);
      var saf=add(st,'safeties'); totals.safeties += saf ? Number(saf.value || saf.displayValue || 0) : 0;
    }
    return totals;
  }
  function parsePBP(pbp){
    var plays=[]; try{
      var gp=pbp && pbp.gamepackageJSON ? pbp.gamepackageJSON : null;
      var prev=gp && gp.drives && gp.drives.previous ? gp.drives.previous : null;
      var curr=gp && gp.drives && gp.drives.current ? gp.drives.current : null;
      function add(arr){ if(Array.isArray(arr)){ for(var i=0;i<arr.length;i++){ if(Array.isArray(arr[i].plays)) plays=plays.concat(arr[i].plays); } } }
      add(prev); add(curr);
    }catch(e){}
    return plays;
  }

  function calcFantasyFrom(summary, box, pbp){
    var comp = summary && summary.header && summary.header.competitions && summary.header.competitions[0] ? summary.header.competitions[0] : {};
    var status = comp.status || {};
    var teams = comp.competitors || [];
    var homeC=null, awayC=null; for(var i=0;i<teams.length;i++){ if(teams[i].homeAway==='home') homeC=teams[i]; if(teams[i].homeAway==='away') awayC=teams[i]; }
    var homePts = Number(homeC && typeof homeC.score!=='undefined' ? homeC.score : 0);
    var awayPts = Number(awayC && typeof awayC.score!=='undefined' ? awayC.score : 0);

    var totals = sumStatsFromSummary(summary);
    var stopsEff = (totals.thirdAtt - totals.thirdMade) + (totals.fourthAtt - totals.fourthMade);

    var TD=0, FG=0, XP=0, TWO=0, stReturnTD=0, blocks=0, defTdBonus=0, safeties=(totals.safeties||0);
    var scoringPlays = summary && summary.scoringPlays ? summary.scoringPlays : [];
    for(var s=0;s<scoringPlays.length;s++){
      var sp=scoringPlays[s];
      var d=String(sp.text||sp.description||'').toLowerCase();
      var t=String((sp.type && sp.type.text)||sp.scoringType||'').toLowerCase();
      if(t.indexOf('touchdown')>-1 || d.indexOf('touchdown')>-1){
        TD++;
        if(d.indexOf('punt return')>-1 || d.indexOf('kickoff return')>-1 || d.indexOf('kick return')>-1) stReturnTD++;
        if(d.indexOf('interception return')>-1 || d.indexOf('fumble return')>-1 || d.indexOf('blocked punt')>-1 || d.indexOf('blocked kick')>-1 || d.indexOf('fumble recovered in end zone')>-1) defTdBonus++;
        if(d.indexOf('safety')>-1) safeties++;
      }else if(t.indexOf('field goal')>-1 || d.indexOf('field goal')>-1){ FG++; }
      else if(t.indexOf('extra point')>-1 || d.indexOf('extra point is good')>-1){ XP++; }
      else if(t.indexOf('two-point')>-1 || d.indexOf('two-point')>-1){ if(d.indexOf('successful')>-1 || d.indexOf('is good')>-1 || d.indexOf('good')>-1) TWO++; }
      if(d.indexOf('blocked')>-1) blocks++;
    }

    var plays = parsePBP(pbp);
    var sacksP=0,tflP=0,stopsP=0,fdP=0,intP=0,frP=0,defTDP=0,stTDP=stReturnTD,safetyP=0,blockP=blocks,xpP=0,twoP=0;
    for(var p=0;p<plays.length;p++){
      var txt=String(plays[p].text||'').toLowerCase();
      if(txt.indexOf('sacked')>-1) sacksP++;
      if(txt.indexOf('tackle for loss')>-1) tflP++;
      var dn=plays[p].down;
      var gotFirst = txt.indexOf('first down')>-1 || /1st and/i.test(txt);
      var tod = txt.indexOf('turnover on downs')>-1;
      var punt = txt.indexOf('punt')===0;
      var fg  = (txt.indexOf('field goal')>-1) && (txt.indexOf('is good')>-1 || txt.indexOf('missed')>-1 || txt.indexOf('blocked')>-1);
      if((dn===3 || dn===4) && !gotFirst && (tod || punt || fg)) stopsP++;
      if(txt.indexOf('first down')>-1) fdP++;
      if(txt.indexOf('intercepted')>-1){ intP++; if(txt.indexOf('for a touchdown')>-1) defTDP++; }
      if(txt.indexOf('fumble')>-1){ if(txt.indexOf('recovered')>-1) frP++; if(txt.indexOf('for a touchdown')>-1 || txt.indexOf('recovered in end zone')>-1) defTDP++; }
      if((txt.indexOf('punt')>-1 || txt.indexOf('kickoff')>-1 || txt.indexOf('kick return')>-1) && txt.indexOf('returns')>-1 && txt.indexOf('for a touchdown')>-1) stTDP++;
      if(txt.indexOf('safety')>-1) safetyP++;
      if(txt.indexOf('blocked punt')>-1 || txt.indexOf('blocked field goal')>-1 || (txt.indexOf('blocked')>-1 && txt.indexOf('kick')>-1)) blockP++;
      if(txt.indexOf('extra point')>-1 && (txt.indexOf('is good')>-1 || txt.indexOf('good')>-1)) xpP++;
      if(txt.indexOf('two-point')>-1 && (txt.indexOf('successful')>-1 || txt.indexOf('good')>-1)) twoP++;
    }
    if(!totals.sacks || totals.sacks<sacksP) totals.sacks=sacksP;
    if(!totals.tfl   || totals.tfl<tflP)     totals.tfl=tflP;
    if(!totals.firstDowns) totals.firstDowns=fdP;

    var stops = Math.max(stopsEff, stopsP);
    var XPf = Math.max(XP, xpP);
    var TWOf = Math.max(TWO, twoP);
    var stTDB = Math.max(stReturnTD, stTDP);
    var safF = Math.max(safeties, safetyP, totals.safeties||0);
    var blockF = Math.max(blocks, blockP);

    var offense = TD*W.TD + FG*W.FG + XPf*W.XP + TWOf*W.TWO + totals.yards*W.YARD + totals.firstDowns*W.FIRST_DOWN;
    var defense = totals.sacks*W.SACK + totals.tfl*W.TFL + intP*W.INT + frP*W.FR + defTdBonus*W.DEF_TD_BONUS + safF*W.SAFETY + stops*W.STOP + stTDB*W.ST_RETURN_TD + blockF*W.BLOCK;

    var isFinal = (status && status.type && (status.type.state==='post' || status.type.completed===true)) ? true : false;
    var margin = Math.abs(homePts-awayPts);
    var closeBonus = (isFinal && margin<=7) ? W.CLOSE_GAME : 0;
    var otBonus = ((status && status.period && status.period>4) && isFinal) ? W.OVERTIME : 0;
    var total = offense + defense + closeBonus + otBonus;

    return {
      total: Number(total.toFixed(2)),
      homePts: homePts,
      awayPts: awayPts,
      statusText: (status && status.type && (status.type.shortDetail || status.type.description)) ? (status.type.shortDetail || status.type.description) : '—',
      isFinal: isFinal
    };
  }

  async function computeRow(eventId){
    var cached = state.gameScoreCache.get(eventId);
    if(cached && cached.isFinal) return cached;
    try{
      var summary = await apiSummary(eventId);
      var box = await apiBox(eventId);
      var pbp = await apiPbp(eventId);

      var comp = summary && summary.header && summary.header.competitions && summary.header.competitions[0] ? summary.header.competitions[0] : {};
      var homeC=null, awayC=null; var cs=comp.competitors||[];
      for(var i=0;i<cs.length;i++){ if(cs[i].homeAway==='home') homeC=cs[i]; if(cs[i].homeAway==='away') awayC=cs[i]; }

      var homeName = homeC && homeC.team ? (homeC.team.shortDisplayName || homeC.team.displayName || 'Home') : 'Home';
      var awayName = awayC && awayC.team ? (awayC.team.shortDisplayName || awayC.team.displayName || 'Away') : 'Away';
      var homeLogo = config.logo(homeC && homeC.team ? homeC.team : null);
      var awayLogo = config.logo(awayC && awayC.team ? awayC.team : null);

      var scoreObj = calcFantasyFrom(summary, box, pbp);
      var row = {
        id: eventId,
        awayName: awayName,
        homeName: homeName,
        awayLogo: awayLogo,
        homeLogo: homeLogo,
        awayPts: scoreObj.awayPts,
        homePts: scoreObj.homePts,
        score: scoreObj.total,
        status: scoreObj.statusText,
        final: scoreObj.isFinal
      };
      if(row.final) state.gameScoreCache.set(eventId,row);
      return row;
    }catch(e){ return null; }
  }

  function renderLB(){
    N.lb.innerHTML='';
    var rows = state.showAll ? state.lbRows : state.lbRows.slice(0,10);
    if(rows.length===0){ N.lb.innerHTML='<div class="small">—</div>'; return; }
    for(var i=0;i<rows.length;i++){
      var r=rows[i];
      var div=document.createElement('div'); div.className='lbRow';
      div.innerHTML =
        '<div class="lbTeam">'+
          (r.awayLogo?('<img src="'+r.awayLogo+'" alt="">'):'')+'<span class="lbName">'+r.awayName+'</span>'+
          '<span class="scoreTag">'+r.awayPts+'</span>'+
          '<span class="small" style="margin:0 6px;opacity:.8">at</span>'+
          (r.homeLogo?('<img src="'+r.homeLogo+'" alt="">'):'')+'<span class="lbName">'+r.homeName+'</span>'+
          '<span class="scoreTag">'+r.homePts+'</span>'+
        '</div>'+
        '<div class="lbPts">'+r.score.toFixed(2)+'</div>'+
        '<div class="lbMeta">'+r.status+'</div>';
      (function(eventId){
        div.addEventListener('click',function(){
          for(var j=0;j<state.weeklyEvents.length;j++){ if(state.weeklyEvents[j].id===eventId){ openGame(state.weeklyEvents[j]); break; } }
        });
      })(r.id);
      N.lb.appendChild(div);
    }
    N.toggleAll.textContent = state.showAll ? 'Show top 10' : 'Show all';
    N.toggleAll.setAttribute('aria-expanded', state.showAll ? 'true' : 'false');
  }

  async function refreshLB(){
    if(!state.weeklyEvents || state.weeklyEvents.length===0){ return; }
    var rows=[];
    for(var i=0;i<state.weeklyEvents.length;i++){
      var r=await computeRow(state.weeklyEvents[i].id);
      if(r) rows.push(r);
    }
    rows.sort(function(a,b){ return b.score-a.score; });
    state.lbRows=rows;
    renderLB();
  }

  async function refreshOnce(){
    if(!state.selected) return;
    try{
      var gameId = state.selected.id;
      var summary = await apiSummary(gameId);
      var box = await apiBox(gameId);
      var pbp = await apiPbp(gameId);

      var comp = summary && summary.header && summary.header.competitions && summary.header.competitions[0] ? summary.header.competitions[0] : {};
      var status = comp.status || {};
      var teams = comp.competitors || [];
      var homeC=null, awayC=null;
      for(var i=0;i<teams.length;i++){ if(teams[i].homeAway==='home') homeC=teams[i]; if(teams[i].homeAway==='away') awayC=teams[i]; }
      var hs=document.getElementById(config.ids.homeScore), as=document.getElementById(config.ids.awayScore);
      if(hs) hs.textContent = String(homeC && typeof homeC.score!=='undefined' ? homeC.score : 0);
      if(as) as.textContent = String(awayC && typeof awayC.score!=='undefined' ? awayC.score : 0);
      N.clock.textContent = status && status.displayClock ? status.displayClock : '—';
      N.q.textContent = status && typeof status.period!=='undefined' ? String(status.period) : '—';
      N.state.textContent = status && status.type && (status.type.description || status.type.shortDetail) ? (status.type.description || status.type.shortDetail) : '—';

      var scoreObj = calcFantasyFrom(summary, box, pbp);
      N.fscore.textContent = scoreObj.total.toFixed(2);
      var closeTxt = (scoreObj.isFinal && Math.abs((Number(homeC && homeC.score || 0))-(Number(awayC && awayC.score || 0)))<=7) ? 'Close (+10)' : '—';
      var otTxt = (status && status.period && status.period>4 && scoreObj.isFinal) ? 'OT (+15)' : '—';
      N.flow.textContent = 'Bonuses: '+closeTxt+' · '+otTxt;

      var sps = summary && summary.scoringPlays ? summary.scoringPlays : [];
      var newLines=[];
      for(var i=0;i<sps.length;i++){
        var id = sps[i].id;
        if(!state.lastScoring.has(id)){
          var time = (sps[i].clock && sps[i].clock.displayValue) ? sps[i].clock.displayValue : '';
          var q = (sps[i].period && sps[i].period.number) ? ('Q'+sps[i].period.number) : '';
          var desc = sps[i].text || sps[i].description || '';
          newLines.push('['+q+' '+time+'] '+desc);
        }
      }
      for(var k=newLines.length-1;k>=0;k--){
        var d=document.createElement('div'); d.textContent=newLines[k]; N.log.prepend(d);
      }
      for(var i2=0;i2<sps.length;i2++){ state.lastScoring.add(sps[i2].id); }
    }catch(e){}
  }

  /* Player Leaderboards */
  async function totalForWeek(pid, wkKey){
    var wk = state.picks[wkKey] ? state.picks[wkKey] : {};
    var ids = wk[pid] && wk[pid].gameIds ? wk[pid].gameIds : [];
    var sum=0;
    for(var i=0;i<ids.length;i++){
      var r=await computeRow(ids[i]); if(r) sum += (r.score||0);
    }
    return sum;
  }
  async function weeklyRankPoints(wkKey){
    var wk=state.picks[wkKey] || {};
    var pids=Object.keys(wk);
    var rows=[];
    for(var i=0;i<pids.length;i++){
      var pid=pids[i];
      var t=await totalForWeek(pid, wkKey);
      rows.push({pid:pid,total:t});
    }
    rows.sort(function(a,b){ return b.total-a.total; });
    var pts={};
    for(var j=0;j<rows.length;j++){ pts[rows[j].pid] = Math.max(10-j,0); }
    return pts;
  }
  async function seasonTotals(){
    var cur=WK;
    var weeks=Object.keys(state.picks).filter(function(w){ return w<cur; }).sort();
    var totals={};
    for(var i=0;i<state.players.length;i++){ totals[state.players[i].id]=0; }
    for(var w=0;w<weeks.length;w++){
      var wk=weeks[w];
      var pts=await weeklyRankPoints(wk);
      var keys=Object.keys(pts);
      for(var k=0;k<keys.length;k++){ var pid=keys[k]; totals[pid]=(totals[pid]||0)+pts[pid]; }
    }
    return totals;
  }
  function nameFor(pid){
    for(var i=0;i<state.players.length;i++){ if(state.players[i].id===pid) return state.players[i].name; }
    return pid;
  }
  async function renderPlayersLB(){
    var wk = state.picks[WK] || {};
    var pids = Object.keys(wk);
    var rows=[];
    for(var i=0;i<pids.length;i++){
      var pid=pids[i]; if(!wk[pid].gameIds || wk[pid].gameIds.length===0) continue;
      var total=await totalForWeek(pid, WK);
      rows.push({name:nameFor(pid), total:total, picks:wk[pid].gameIds.length});
    }
    rows.sort(function(a,b){ return b.total-a.total; });
    N.pLB.innerHTML='';
    if(rows.length===0){ N.pLB.innerHTML='<div class="small">No picks this week.</div>'; return; }
    for(var r=0;r<rows.length;r++){
      var row=rows[r];
      var div=document.createElement('div'); div.className='lbRow';
      div.innerHTML='<div class="lbTeam"><span class="lbName">'+row.name+'</span> <span class="small" style="margin-left:6px;opacity:.8">('+row.picks+'/'+PICKS_REQUIRED+')</span></div><div class="lbPts">'+row.total.toFixed(2)+'</div><div class="lbMeta">Weekly</div>';
      N.pLB.appendChild(div);
    }
  }
  async function renderSeasonLB(){
    var totals=await seasonTotals();
    function anyPick(pid){
      var weeks=Object.keys(state.picks);
      for(var i=0;i<weeks.length;i++){ var wk=state.picks[weeks[i]]; if(wk[pid] && wk[pid].gameIds && wk[pid].gameIds.length) return true; }
      return false;
    }
    var rows=[];
    for(var i=0;i<state.players.length;i++){
      var pid=state.players[i].id;
      if(anyPick(pid)) rows.push({name:state.players[i].name, total: totals[pid]||0});
    }
    rows.sort(function(a,b){ return b.total-a.total; });
    N.pSeason.innerHTML='';
    if(rows.length===0){ N.pSeason.innerHTML='<div class="small">No season data yet.</div>'; return; }
    for(var r=0;r<rows.length;r++){
      var row=rows[r]; var div=document.createElement('div'); div.className='lbRow';
      div.innerHTML='<div class="lbTeam"><span class="lbName">'+row.name+'</span></div><div class="lbPts">'+row.total+'</div><div class="lbMeta">Season</div>';
      N.pSeason.appendChild(div);
    }
  }

  /* Controls */
  N.addPickBtn.addEventListener('click', function(){
    if(!state.selected) return;
    var pid=currentPlayerId(); if(!pid){ alert('Add/select a player first.'); return; }
    if(isLocked(state.selected)) return;
    var wk=picksFor(pid);
    if(wk.gameIds.indexOf(state.selected.id)!==-1){ alert('Already picked.'); return; }
    if(wk.gameIds.length>=PICKS_REQUIRED){ alert('You already have '+PICKS_REQUIRED+' picks.'); return; }
    wk.gameIds.push(state.selected.id); save('picks',state.picks); updatePicksLeft(); renderPlayersPanel(); renderPlayersLB(); renderSeasonLB();
  });
  N.toggleAll.addEventListener('click',function(){ state.showAll=!state.showAll; renderLB(); });

  /* Boot */
  (async function boot(){
    try{
      state.players = load('players', []);
      state.picks = load('picks', {});
      ensureAI(); save('players', state.players);
      refreshPlayerSelect();
      renderPlayersPanel();
      await loadWeek();
      wireBack();

      setInterval(function(){ if(sectionVisible(config.sectionId)) renderPlayersLB(); }, LB_POLL_MS);
      setInterval(function(){ if(sectionVisible(config.sectionId)) renderSeasonLB(); }, LB_POLL_MS*2);
    }catch(e){}
  })();

  // expose reset helpers
  window[config.prefix+'ResetAll']=function(){
    localStorage.removeItem(config.prefix+'.players');
    localStorage.removeItem(config.prefix+'.picks');
    location.reload();
  };
  window[config.prefix+'ClearWeek']=function(){
    var all = load('picks', {});
    var weeks = Object.keys(all);
    if(weeks.length){ delete all[weeks[weeks.length-1]]; save('picks',all); }
    location.reload();
  };
}

/* ===== Build leagues ===== */
var nfl = createLeague({
  sectionId: 'sec-nfl',
  prefix: 'nfl',
  label: 'NFL',
  logo: cdnNFL,
  ids: { awayScore: 'awayScoreNFL', homeScore: 'homeScoreNFL', backBtn: 'nfl-backBtn' },
  nodes: {
    top: document.getElementById('nfl-top'),
    splash: document.getElementById('nfl-splash'),
    tracker: document.getElementById('nfl-tracker'),
    liveHeader: document.getElementById('nfl-liveHeader'),
    teamSide: document.getElementById('nfl-teamSide'),
    playerSelect: document.getElementById('nfl-playerSelect'),
    addPickBtn: document.getElementById('nfl-addPickBtn'),
    picksLeft: document.getElementById('nfl-picksLeft'),
    jump: document.getElementById('nfl-jump'),
    jumpBtn: document.getElementById('nfl-jumpBtn'),
    fscore: document.getElementById('nfl-fscore'),
    flow: document.getElementById('nfl-flow'),
    clock: document.getElementById('nfl-clock'),
    q: document.getElementById('nfl-q'),
    state: document.getElementById('nfl-state'),
    weekNote: document.getElementById('nfl-weekNote'),
    gridNote: document.getElementById('nfl-gridNote'),
    grid: document.getElementById('nfl-grid'),
    lb: document.getElementById('nfl-lb'),
    toggleAll: document.getElementById('nfl-toggleAll'),
    pLB: document.getElementById('nfl-pLB'),
    pSeason: document.getElementById('nfl-pSeason'),
    log: document.getElementById('nfl-log'),
    playersWrap: document.getElementById('nfl-playersWrap'),
    playersToggle: document.getElementById('nfl-playersToggle'),
    playersContent: document.getElementById('nfl-playersContent'),
    newPlayer: document.getElementById('nfl-newPlayer'),
    addPlayer: document.getElementById('nfl-addPlayer'),
    clearWeek: document.getElementById('nfl-clearWeek'),
    playersPanel: document.getElementById('nfl-playersPanel')
  },
  endpoints: {
    scoreboard: 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates=',
    summary: 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=',
    box: 'https://cdn.espn.com/core/nfl/boxscore?xhr=1&gameId=',
    pbp: 'https://cdn.espn.com/core/nfl/playbyplay?xhr=1&gameId=',
    odds: function(id){ return 'https://sports.core.api.espn.com/v2/sports/football/leagues/nfl/events/'+id+'/competitions/'+id+'/odds'; }
  }
});

var ncaaf = createLeague({
  sectionId: 'sec-ncaaf',
  prefix: 'ncaaf',
  label: 'NCAA FBS',
  logo: cdnNCAAF,
  ids: { awayScore: 'awayScoreNCAAF', homeScore: 'homeScoreNCAAF', backBtn: 'ncaaf-backBtn' },
  nodes: {
    top: document.getElementById('ncaaf-top'),
    splash: document.getElementById('ncaaf-splash'),
    tracker: document.getElementById('ncaaf-tracker'),
    liveHeader: document.getElementById('ncaaf-liveHeader'),
    teamSide: document.getElementById('ncaaf-teamSide'),
    playerSelect: document.getElementById('ncaaf-playerSelect'),
    addPickBtn: document.getElementById('ncaaf-addPickBtn'),
    picksLeft: document.getElementById('ncaaf-picksLeft'),
    jump: document.getElementById('ncaaf-jump'),
    jumpBtn: document.getElementById('ncaaf-jumpBtn'),
    fscore: document.getElementById('ncaaf-fscore'),
    flow: document.getElementById('ncaaf-flow'),
    clock: document.getElementById('ncaaf-clock'),
    q: document.getElementById('ncaaf-q'),
    state: document.getElementById('ncaaf-state'),
    weekNote: document.getElementById('ncaaf-weekNote'),
    gridNote: document.getElementById('ncaaf-gridNote'),
    grid: document.getElementById('ncaaf-grid'),
    lb: document.getElementById('ncaaf-lb'),
    toggleAll: document.getElementById('ncaaf-toggleAll'),
    pLB: document.getElementById('ncaaf-pLB'),
    pSeason: document.getElementById('ncaaf-pSeason'),
    log: document.getElementById('ncaaf-log'),
    playersWrap: document.getElementById('ncaaf-playersWrap'),
    playersToggle: document.getElementById('ncaaf-playersToggle'),
    playersContent: document.getElementById('ncaaf-playersContent'),
    newPlayer: document.getElementById('ncaaf-newPlayer'),
    addPlayer: document.getElementById('ncaaf-addPlayer'),
    clearWeek: document.getElementById('ncaaf-clearWeek'),
    playersPanel: document.getElementById('ncaaf-playersPanel')
  },
  endpoints: {
    scoreboard: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?dates=',
    summary: 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/summary?event=',
    box: 'https://cdn.espn.com/core/college-football/boxscore?xhr=1&gameId=',
    pbp: 'https://cdn.espn.com/core/college-football/playbyplay?xhr=1&gameId=',
    odds: function(id){ return 'https://sports.core.api.espn.com/v2/sports/football/leagues/college-football/events/'+id+'/competitions/'+id+'/odds'; }
  }
});

/* Tabs */
var tabNFL=document.getElementById('tab-nfl'), tabNCAAF=document.getElementById('tab-ncaaf');
var secNFL=document.getElementById('sec-nfl'), secNCAAF=document.getElementById('sec-ncaaf');
function selectTab(which){
  if(which==='nfl'){
    tabNFL.setAttribute('aria-selected','true'); tabNCAAF.setAttribute('aria-selected','false');
    secNFL.classList.add('active'); secNCAAF.classList.remove('active');
  }else{
    tabNFL.setAttribute('aria-selected','false'); tabNCAAF.setAttribute('aria-selected','true');
    secNFL.classList.remove('active'); secNCAAF.classList.add('active');
  }
}
tabNFL.addEventListener('click',function(){ selectTab('nfl'); });
tabNCAAF.addEventListener('click',function(){ selectTab('ncaaf'); });
</script>
</body>
</html>
