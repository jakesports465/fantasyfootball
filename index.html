<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Football Fantasy ‚Äî NFL & NCAA ¬∑ Supabase</title>
<link rel="preconnect" href="https://a.espncdn.com">
<style>
:root{--bg:#0b0d10;--card:#11161d;--muted:#90a3b6;--text:#e9eef5;--accent:#2f86ff;--ok:#3ac47d;--warn:#ffb020;--err:#ff5b5b;}
html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{padding:14px 20px;border-bottom:1px solid #1c2430;background:#0e1319;position:sticky;top:0;z-index:40}
h1{margin:0;font-size:18px}
.sub{color:var(--muted);font-size:13px;margin-left:6px}

nav.tabs{display:flex;gap:8px;padding:10px 20px;background:#0e1319;border-bottom:1px solid #1c2430;position:sticky;top:52px;z-index:39;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid #24303c;border-radius:10px;background:#101822;color:var(--text);cursor:pointer;font-size:13px}
.tab[aria-selected="true"]{background:#162233;border-color:#2f4e67;font-weight:700}
.section{display:none}
.section.active{display:block}

main{max-width:1200px;margin:0 auto;padding:16px 20px 40px}
.card{background:var(--card);border:1px solid #1b2330;border-radius:14px;padding:16px}
.panel{background:#0f151d;border:1px solid #1b2330;border-radius:12px;padding:12px}
.sep{height:1px;background:#19212c;margin:12px 0}
.small{font-size:12px;color:var(--muted)}
.btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px}
.btn.small{padding:6px 8px;font-size:12px}
.btn[disabled]{opacity:.6;cursor:not-allowed}
input[type="email"],input[type="password"],input[type="text"]{background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:8px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

.gamesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.gameCard{background:#10161e;border:1px solid #1e2a37;border-radius:14px;overflow:hidden}
.band{height:6px}
.gameBody{padding:12px}
.teamsRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
.team{display:flex;align-items:center;gap:8px;min-width:0}
.team img{width:26px;height:26px;border-radius:6px;border:1px solid #1e2732;background:#0f1318}
.team .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.scoreTag{display:inline-block;margin-left:6px;padding:2px 6px;border:1px solid #26313c;border-radius:6px;font-weight:700}
.lockRow{display:flex;gap:8px;margin-top:10px}
.disabledNote{margin-top:6px;font-size:12px;color:#c78}

.topGrid{display:grid;grid-template-columns:1fr 260px 260px;gap:14px;align-items:start}
@media(max-width:980px){.topGrid{grid-template-columns:1fr}}
.teamline{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:12px;background:#0f151d;border:1px solid #1b2330}
.teamline img{width:28px;height:28px;border-radius:6px;border:1px solid #1e2732;background:#0d1218}
.statusBox,.scoreBox{background:#0f151d;border:1px solid #1b2330;border-radius:12px;padding:12px}
.scoreBox{text-align:center}
.scoreBox .num{font-size:42px;font-weight:900}

.contentGrid{display:grid;grid-template-columns:1.6fr 1fr;gap:16px}
@media(max-width:1060px){.contentGrid{grid-template-columns:1fr}}
.log{max-height:260px;overflow:auto;background:#0f151d;border-radius:10px;padding:8px;border:1px solid #1b232d}

.lbHeaderRow{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.lbRow{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:8px;border-radius:10px;border:1px solid #1c2430;background:#0f151d;margin-bottom:8px;cursor:pointer}
.lbTeam{display:flex;gap:8px;align-items:center;min-width:0}
.lbTeam img{width:20px;height:20px;border-radius:4px;border:1px solid #1c2330;background:#0d1218}
.lbName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lbPts{font-weight:700}
.lbMeta{font-size:12px;color:var(--muted)}
.authBadge{display:inline-block;padding:3px 8px;border:1px solid #2a3949;border-radius:999px;background:#0f1822}

.picksList .rowx{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px;border-radius:10px;border:1px solid #1c2430;background:#0f151d;margin-bottom:8px}
.picksList .left{display:flex;gap:8px;align-items:center;min-width:0}
.picksList img{width:20px;height:20px;border:1px solid #1c2330;border-radius:4px;background:#0d1218}

/* Toasts */
#toasts{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:50}
.toast{background:#0f151d;border:1px solid #1b2a3a;color:var(--text);border-radius:10px;padding:10px 12px;min-width:220px;max-width:90vw;box-shadow:0 8px 24px rgba(0,0,0,.3);display:flex;gap:8px;align-items:flex-start}
.toast.ok{border-color:#224b34}
.toast.warn{border-color:#4b3f22}
.toast.err{border-color:#4b2222}
.toast .tag{font-weight:800;opacity:.9}
.toast .msg{font-size:13px;opacity:.95}
.toast button{margin-left:auto;background:transparent;border:0;color:var(--muted);cursor:pointer}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <h1>Football Fantasy <span class="sub">NFL & NCAA ¬∑ Tue‚ÜíMon ¬∑ 3 picks ¬∑ Supabase</span></h1>
</header>

<!-- ACCOUNT -->
<main style="max-width:1200px;margin:0 auto;padding:12px 20px 0">
  <section class="card">
    <div class="row">
      <div><strong>Account</strong> <span id="authState" class="authBadge">Signed out</span></div>
    </div>
    <div class="sep"></div>
    <div id="authSignedOut">
      <div class="row">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button id="btnSignUp" class="btn small">Sign up</button>
        <button id="btnSignIn" class="btn small">Sign in</button>
      </div>
      <div class="small" style="margin-top:6px">Confirm by email the first time, then just sign in.</div>
    </div>
    <div id="authSignedIn" style="display:none">
      <div class="row">
        <div class="small">Signed in as <span id="whoami" style="font-weight:700">‚Äî</span></div>
        <button id="btnSignOut" class="btn small">Sign out</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <input id="displayName" type="text" placeholder="Your display name (e.g., Jake)">
        <button id="btnSaveName" class="btn small">Save name</button>
        <span id="nameSaved" class="small" style="display:none">Saved ‚úì</span>
      </div>
    </div>
  </section>
</main>

<!-- TABS -->
<nav class="tabs" role="tablist" aria-label="Leagues">
  <button id="tab-nfl" class="tab" role="tab" aria-controls="sec-nfl" aria-selected="true">
    NFL <span id="nfl-picksBadge" class="small" style="margin-left:6px;opacity:.85"></span>
  </button>
  <button id="tab-ncaaf" class="tab" role="tab" aria-controls="sec-ncaaf" aria-selected="false">
    NCAA (FBS) <span id="ncaaf-picksBadge" class="small" style="margin-left:6px;opacity:.85"></span>
  </button>
  <button id="tab-mine" class="tab" role="tab" aria-controls="sec-mine" aria-selected="false">My Picks</button>
  <button id="tab-lb" class="tab" role="tab" aria-controls="sec-lb" aria-selected="false">Leaderboards</button>
</nav>

<!-- NFL -->
<section id="sec-nfl" class="section active" aria-labelledby="tab-nfl">
  <main>
    <div id="nfl-top" class="card" style="display:none">
      <div class="small" id="nfl-liveHeader">‚Äî</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0">
        <button id="nfl-backBtn" class="btn small" style="display:none">‚Üê Back to games</button>
        <span id="nfl-picksLeft" class="small" style="opacity:.85"></span>
        <span class="small" style="margin-left:10px;opacity:.8">Jump:</span>
        <select id="nfl-jump" class="btn small" style="min-width:260px;max-width:60vw"></select>
        <button id="nfl-jumpBtn" class="btn small">View</button>
        <button id="nfl-addPickBtn" class="btn small">Add to my picks</button>
      </div>
      <div class="topGrid">
        <div id="nfl-teamSide"></div>
        <div class="scoreBox">
          <div class="small" style="margin-bottom:4px">Fantasy Score</div>
          <div id="nfl-fscore" class="num">‚Äî</div>
          <div id="nfl-flow" class="small"></div>
        </div>
        <div class="statusBox">
          <div class="small" style="margin-bottom:4px">Game Status</div>
          <div class="small">Clock: <span id="nfl-clock" style="font-weight:700">‚Äî</span></div>
          <div class="small">Quarter: <span id="nfl-q" style="font-weight:700">‚Äî</span></div>
          <div class="small">State: <span id="nfl-state" style="font-weight:700">‚Äî</span></div>
        </div>
      </div>
    </div>

    <section id="nfl-splash" class="card">
      <div id="nfl-weekNote" class="small">Loading‚Ä¶</div>
      <div class="sep"></div>
      <div id="nfl-gridNote" class="small">‚Äî</div>
      <div id="nfl-grid" class="gamesGrid"></div>
    </section>

    <section id="nfl-tracker" style="display:none">
      <div class="contentGrid">
        <section class="card">
          <div class="lbHeaderRow">
            <h2 style="margin:0">Games Leaderboard (Top 10)</h2>
            <button id="nfl-toggleAll" class="btn small" aria-expanded="false">Show all</button>
          </div>
          <div id="nfl-lb"></div>
        </section>
        <section class="card">
          <h3 style="margin:0 0 6px 0">Scoring Plays</h3>
          <div id="nfl-log" class="log"></div>
        </section>
      </div>
    </section>
  </main>
</section>

<!-- NCAA -->
<section id="sec-ncaaf" class="section" aria-labelledby="tab-ncaaf">
  <main>
    <div id="ncaaf-top" class="card" style="display:none">
      <div class="small" id="ncaaf-liveHeader">‚Äî</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0">
        <button id="ncaaf-backBtn" class="btn small" style="display:none">‚Üê Back to games</button>
        <span id="ncaaf-picksLeft" class="small" style="opacity:.85"></span>
        <span class="small" style="margin-left:10px;opacity:.8">Jump:</span>
        <select id="ncaaf-jump" class="btn small" style="min-width:260px;max-width:60vw"></select>
        <button id="ncaaf-jumpBtn" class="btn small">View</button>
        <button id="ncaaf-addPickBtn" class="btn small">Add to my picks</button>
      </div>
      <div class="topGrid">
        <div id="ncaaf-teamSide"></div>
        <div class="scoreBox">
          <div class="small" style="margin-bottom:4px">Fantasy Score</div>
          <div id="ncaaf-fscore" class="num">‚Äî</div>
          <div id="ncaaf-flow" class="small"></div>
        </div>
        <div class="statusBox">
          <div class="small" style="margin-bottom:4px">Game Status</div>
          <div class="small">Clock: <span id="ncaaf-clock" style="font-weight:700">‚Äî</span></div>
          <div class="small">Quarter: <span id="ncaaf-q" style="font-weight:700">‚Äî</span></div>
          <div class="small">State: <span id="ncaaf-state" style="font-weight:700">‚Äî</span></div>
        </div>
      </div>
    </div>

    <section id="ncaaf-splash" class="card">
      <div id="ncaaf-weekNote" class="small">Loading‚Ä¶</div>
      <div class="sep"></div>
      <div id="ncaaf-gridNote" class="small">‚Äî</div>
      <div id="ncaaf-grid" class="gamesGrid"></div>
    </section>

    <section id="ncaaf-tracker" style="display:none">
      <div class="contentGrid">
        <section class="card">
          <div class="lbHeaderRow">
            <h2 style="margin:0">Games Leaderboard (Top 10)</h2>
            <button id="ncaaf-toggleAll" class="btn small" aria-expanded="false">Show all</button>
          </div>
          <div id="ncaaf-lb"></div>
        </section>
        <section class="card">
          <h3 style="margin:0 0 6px 0">Scoring Plays</h3>
          <div id="ncaaf-log" class="log"></div>
        </section>
      </div>
    </section>
  </main>
</section>

<!-- MY PICKS (both leagues) -->
<section id="sec-mine" class="section" aria-labelledby="tab-mine">
  <main>
    <section class="card">
      <div class="lbHeaderRow"><h2 style="margin:0">My Picks ‚Äî This Week (NFL & NCAA)</h2></div>
      <div id="mine-list" class="picksList"></div>
      <div class="small" style="margin-top:6px">Tip: Open a game from NFL or NCAA to add picks. 3 picks max per league each week.</div>
    </section>
  </main>
</section>

<!-- LEADERBOARDS (both leagues summary) -->
<section id="sec-lb" class="section" aria-labelledby="tab-lb">
  <main>
    <div class="contentGrid">
      <section class="card">
        <div class="lbHeaderRow">
          <h2 style="margin:0">Games Leaderboard ‚Äî NFL (Top 10)</h2>
          <button id="lbNFLtoggle" class="btn small" aria-expanded="false">Show all</button>
        </div>
        <div id="lbNFL" ></div>
        <div class="sep"></div>
        <div class="lbHeaderRow">
          <h2 style="margin:0">Games Leaderboard ‚Äî NCAA (Top 10)</h2>
          <button id="lbNCAAtoggle" class="btn small" aria-expanded="false">Show all</button>
        </div>
        <div id="lbNCAA"></div>
      </section>
      <section class="card">
        <div class="lbHeaderRow"><h2 style="margin:0">Players ‚Äî Weekly (NFL)</h2></div>
        <div id="pNFLweek"></div>
        <div class="sep"></div>
        <div class="lbHeaderRow"><h2 style="margin:0">Players ‚Äî Weekly (NCAA)</h2></div>
        <div id="pNCAAweek"></div>
        <div class="sep"></div>
        <div class="lbHeaderRow"><h2 style="margin:0">Players ‚Äî Season (NFL)</h2></div>
        <div id="pNFLseason"></div>
        <div class="sep"></div>
        <div class="lbHeaderRow"><h2 style="margin:0">Players ‚Äî Season (NCAA)</h2></div>
        <div id="pNCAAseason"></div>
      </section>
    </div>
  </main>
</section>

<!-- Toasts -->
<div id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
/* ================= SUPABASE ================= */
const SB_URL  = "https://zrsqxylrcblcvtomamgd.supabase.co";     // <-- replace
const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyc3F4eWxyY2JsY3Z0b21hbWdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNDAzOTYsImV4cCI6MjA3MjgxNjM5Nn0._H00AQ0VCLs3fkM2lKaWV-I4n9qKf51yjKmorxnonzw";                 // <-- replace
const sb = supabase.createClient(SB_URL, SB_ANON);

/* Tiny DOM helper early */
function $(id){ return document.getElementById(id); }

/* Toasts */
function showToast(kind, tag, msg, ms){ 
  var wrap=$('toasts'); var el=document.createElement('div'); el.className='toast '+(kind||'');
  el.innerHTML='<div class="tag">'+(tag||'Info')+'</div><div class="msg">'+(msg||'')+'</div><button title="Close">‚úï</button>';
  el.querySelector('button').onclick=()=>wrap.removeChild(el);
  wrap.appendChild(el);
  setTimeout(()=>{ if(el.parentNode===wrap) wrap.removeChild(el); }, ms||4000);
}

/* Hard sign-out fallback */
const SB_PROJECT_REF=(function(){const m=SB_URL.match(/^https?:\/\/([^.]+)\.supabase\.co/i);return m?m[1]:null;})();
async function hardSignOut(){
  try{ await sb.auth.signOut(); }catch(e){ console.warn('signOut error',e); }
  try{ if(SB_PROJECT_REF) localStorage.removeItem(`sb-${SB_PROJECT_REF}-auth-token`); }catch(e){}
  $('authSignedOut').style.display='block';
  $('authSignedIn').style.display='none';
  $('authState').textContent='Signed out';
  showToast('ok','Signed out','You have been signed out.');
  location.reload();
}

/* ================= CONFIG / UTILS ================= */
var TZ='America/New_York';
var POLL_MS=20000, LB_POLL_MS=60000, GRID_POLL_MS=30000;
var PICKS_REQUIRED=3;
var W={TD:3,FG:2,XP:0.5,TWO:1,YARD:0.05,FIRST_DOWN:0.5,SACK:2.5,TFL:1.5,INT:5.5,FR:5,DEF_TD_BONUS:3,SAFETY:6,STOP:2,ST_RETURN_TD:8,BLOCK:5,CLOSE_GAME:10,OVERTIME:15};

function nowEST(){return new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));}
function addDaysEST(d,n){var x=new Date(d.getTime());x.setDate(x.getDate()+n);return new Date(x.toLocaleString('en-US',{timeZone:TZ}));}
function fmtParts(d,opts){var p=new Intl.DateTimeFormat('en-US',opts).formatToParts(d),o={};for(var i=0;i<p.length;i++)o[p[i].type]=p[i].value;return o;}
function fmtDateStr(d){return d.split('-').join('');}
function timeout(ms){return new Promise(r=>setTimeout(r,ms));}
async function safeFetch(url,opts,retries){var r=(typeof retries==='number')?retries:2;for(var i=0;i<=r;i++){try{var ctl=new AbortController();var t=setTimeout(()=>ctl.abort(),15000);var res=await fetch(url,Object.assign({},opts||{},{signal:ctl.signal}));clearTimeout(t);if(!res.ok)throw new Error('HTTP '+res.status);return await res.json()}catch(e){if(i===r)throw e;await timeout(600*(i+1));}}}

/* Week key Tue‚ÜíMon at 8am ET + boundary refresh */
(function(){var cur=weekKey();setInterval(()=>{var wk=weekKey();if(wk!==cur)location.reload();},60000);})();
function weekKey(){var n=nowEST(),wd=n.getDay(),since=(wd-2+7)%7,tue=addDaysEST(n,-since);
  var parts=fmtParts(n,{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
  var after8=Number(parts.hour)>=8||since>0,anchor=after8?tue:addDaysEST(tue,-7);
  var k=fmtParts(anchor,{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'});return k.year+'-'+k.month+'-'+k.day+'-Tue08ET';}
function weekDateList(){var n=nowEST(),wd=n.getDay(),since=(wd-2+7)%7,tue=addDaysEST(n,-since),dates=[];
  for(var i=0;i<7;i++){var d=addDaysEST(tue,i);var p=fmtParts(d,{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'});dates.push(p.year+'-'+p.month+'-'+p.day);}
  var pTue=fmtParts(tue,{timeZone:TZ,month:'2-digit',day:'2-digit'}),mon=addDaysEST(tue,6),pMon=fmtParts(mon,{timeZone:TZ,month:'2-digit',day:'2-digit'});
  return{start:dates[0],end:dates[6],list:dates,pretty:pTue.month+'/'+pTue.day+' ‚Üí '+pMon.month+'/'+pMon.day};}

function cdnNFL(t){if(!t)return null;if(t.logos&&t.logos[0]&&t.logos[0].href)return String(t.logos[0].href).replace(/^http:/,'https:');if(t.abbreviation)return 'https://a.espncdn.com/i/teamlogos/nfl/500/'+t.abbreviation+'.png';return null;}
function cdnNCAAF(t){if(!t)return null;if(t.logos&&t.logos[0]&&t.logos[0].href)return String(t.logos[0].href).replace(/^http:/,'https:');if(t.id)return 'https://a.espncdn.com/i/teamlogos/ncaa/500/'+t.id+'.png';if(t.abbreviation)return 'https://a.espncdn.com/i/teamlogos/ncaa/500/'+t.abbreviation+'.png';return null;}

/* ================= AUTH UI ================= */
const elSignedOut=$('authSignedOut'), elSignedIn=$('authSignedIn'), elState=$('authState'), elWho=$('whoami');
const elEmail=$('email'), elPass=$('password'), elDispName=$('displayName'), elNameSaved=$('nameSaved');

$('btnSignUp').addEventListener('click',async()=>{
  const {error}=await sb.auth.signUp({email:elEmail.value.trim(),password:elPass.value.trim()});
  if(error){ showToast('err','Sign up failed',error.message||''); }
  else { showToast('ok','Check email','Confirm, then sign in.'); }
});
$('btnSignIn').addEventListener('click',async()=>{
  const {error}=await sb.auth.signInWithPassword({email:elEmail.value.trim(),password:elPass.value.trim()});
  if(error){ showToast('err','Sign in failed',error.message||''); }
});
$('btnSignOut').addEventListener('click',async(e)=>{ e.preventDefault(); await hardSignOut(); });

$('btnSaveName').addEventListener('click',async()=>{
  const nm=(elDispName.value||'').trim(); if(!nm){showToast('warn','Missing','Enter a display name');return;}
  const u=(await sb.auth.getUser()).data.user; if(!u){showToast('warn','Sign in','Sign in first');return;}
  await sb.from('players').delete().eq('user_id',u.id);
  const {error}=await sb.from('players').insert({user_id:u.id,display_name:nm});
  if(error){ showToast('err','Save failed', error.message||''); return; }
  elNameSaved.style.display='inline'; setTimeout(()=>elNameSaved.style.display='none',1200);
  showToast('ok','Saved', 'Display name updated');
  updateTabPickBadges(); NFL.refreshBoards(); NCAAF.refreshBoards(); renderMyTab();
});

sb.auth.onAuthStateChange(async(_evt,session)=>{
  const user=session&&session.user;
  if(user){
    elSignedOut.style.display='none'; elSignedIn.style.display='block';
    elState.textContent='Signed in'; elWho.textContent=user.email||user.id;
    const {data}=await sb.from('players').select('*').eq('user_id',user.id).limit(1);
    if(data&&data.length) elDispName.value=data[0].display_name;
    showToast('ok','Signed in', user.email||'');
  }else{
    elSignedOut.style.display='block'; elSignedIn.style.display='none'; elState.textContent='Signed out';
  }
  bootOnce(); updateTabPickBadges(); renderMyTab();
});

/* ================= SHARED HELPERS ================= */
async function updateTabPickBadges(){
  const u=(await sb.auth.getUser()).data.user;
  const nflEl=$('nfl-picksBadge'), ncaEl=$('ncaaf-picksBadge');
  if(!u){ nflEl.textContent=''; ncaEl.textContent=''; return; }
  const WK=weekKey();
  const [{data:nflRows},{data:ncaRows}] = await Promise.all([
    sb.from('picks').select('id').eq('user_id',u.id).eq('league','nfl').eq('week_key',WK),
    sb.from('picks').select('id').eq('user_id',u.id).eq('league','ncaaf').eq('week_key',WK),
  ]);
  const nflLeft=Math.max(PICKS_REQUIRED-(nflRows?.length||0),0);
  const ncaLeft=Math.max(PICKS_REQUIRED-(ncaRows?.length||0),0);
  nflEl.textContent=nflLeft?`(${nflLeft} left)`:'(‚úì done)';
  ncaEl.textContent=ncaLeft?`(${ncaLeft} left)`:'(‚úì done)';
}
setInterval(updateTabPickBadges,30000);

/* ================= LEAGUE FACTORY ================= */
function createLeague(config){
  var state={selected:null,weeklyEvents:[],started:new Set(),lastScoring:new Set(),gameScoreCache:new Map(),lbRows:[],showAll:false,gridTimer:null,lbTimer:null,pollTimer:null};
  var WK=weekKey();
  var N=config.nodes;

  function showTop(b){N.top.style.display=b?'block':'none';}
  function showSplash(b){N.splash.style.display=b?'block':'none';}
  function showTracker(b){N.tracker.style.display=b?'block':'none';}
  function visible(){return document.getElementById(config.sectionId).classList.contains('active');}
  function isLocked(g){try{if(state.started.has(g.id))return true;var now=nowEST().getTime(),kick=new Date(g.start).getTime();if(now>=kick){state.started.add(g.id);return true;}return false;}catch(e){return false;}}

  /* ESPN endpoints */
  function apiScoreboard(d){return safeFetch(config.endpoints.scoreboard+fmtDateStr(d));}
  function apiSummary(id){return safeFetch(config.endpoints.summary+id);}
  function apiBox(id){return safeFetch(config.endpoints.box+id);}
  function apiPbp(id){return safeFetch(config.endpoints.pbp+id);}

  /* GRID RENDER */
  function renderGrid(list){
    N.grid.innerHTML='';
    for(var i=0;i<list.length;i++){
      var g=list[i]; var started=isLocked(g);
      var band='linear-gradient(90deg,'+(g.away.color?('#'+g.away.color):'#1a232d')+' 0%,'+(g.home.color?('#'+g.home.color):'#26313c')+' 100%)';
      var kickoff=new Date(g.start).toLocaleString([], {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'2-digit'});
      var card=document.createElement('div'); card.className='gameCard';
      card.innerHTML=
        '<div class="band" style="background:'+band+'"></div>'+
        '<div class="gameBody">'+
          '<div class="teamsRow">'+
            '<div class="team">'+(g.away.logo?'<img src="'+g.away.logo+'">':'')+'<div class="name">'+g.away.name+'</div><span class="scoreTag" id="'+config.prefix+'-a-'+g.id+'">0</span></div>'+
            '<div class="small" style="opacity:.8">@</div>'+
            '<div class="team" style="justify-content:flex-end">'+(g.home.logo?'<img src="'+g.home.logo+'">':'')+'<div class="name">'+g.home.name+'</div><span class="scoreTag" id="'+config.prefix+'-h-'+g.id+'">0</span></div>'+
          '</div>'+
          '<div class="small" style="margin-top:6px;opacity:.9">Score: <span id="'+config.prefix+'-scr-'+g.id+'">‚Äî</span> ¬∑ <span id="'+config.prefix+'-st-'+g.id+'">pre</span> ¬∑ Kick: '+kickoff+'</div>'+
          '<div class="lockRow"><button class="btn lockBtn" '+(started?'disabled':'')+'>üîí Add to my picks</button><button class="btn small viewBtn">Open</button></div>'+
          (started?'<div class="disabledNote">Locked (already started)</div>':'')+
        '</div>';

      (function attachHandlers(gg){
        card.querySelector('.viewBtn').addEventListener('click', function(){ openGame(gg); });
        card.querySelector('.lockBtn').addEventListener('click', async function(){
          if (isLocked(gg)) { showToast('warn','Locked','Game already started'); return; }
          const u=(await sb.auth.getUser()).data.user; if(!u){ showToast('warn','Sign in','Sign in first'); return; }
          const { data: mine } = await sb.from('picks').select('id')
            .eq('user_id',u.id).eq('league',config.prefix).eq('week_key',WK);
          if (mine && mine.length>=PICKS_REQUIRED){ showToast('warn','Limit reached',`You already have ${PICKS_REQUIRED} picks this week`); return; }
          const { error } = await sb.from('picks').insert({ user_id:u.id, league:config.prefix, week_key:WK, game_id:gg.id });
          if (error){ console.error('Insert pick error:', error); showToast('err','Pick failed', error.message||''); return; }
          showToast('ok','Pick saved','Added to your picks');
          updateTabPickBadges(); renderMyPicks(); renderPlayersLB(); renderSeasonLB(); renderMyTab();
        });
      })(g);

      N.grid.appendChild(card);
    }
  }

  function fillJump(){
    N.jump.innerHTML='';
    var items=state.weeklyEvents.slice().sort((a,b)=>new Date(a.start)-new Date(b.start));
    for(var i=0;i<items.length;i++){
      var g=items[i], o=document.createElement('option');
      var when=new Date(g.start).toLocaleString([],{weekday:'short',hour:'numeric',minute:'2-digit'});
      o.value=g.id; o.textContent=when+' ‚Äî '+g.away.name+' @ '+g.home.name;
      N.jump.appendChild(o);
    }
  }
  N.jumpBtn.addEventListener('click',function(){ var id=N.jump.value; var g=state.weeklyEvents.find(x=>x.id===id); if(g) openGame(g); });

  function openGame(g){
    state.selected=g;
    N.liveHeader.textContent=g.away.name+' @ '+g.home.name;
    N.teamSide.innerHTML=
      '<div class="teamline" style="border-left:6px solid '+(g.away.color?('#'+g.away.color):'#2a3643')+'"><div style="display:flex;gap:10px;align-items:center">'+(g.away.logo?'<img src="'+g.away.logo+'">':'')+'<div style="font-weight:700">'+g.away.name+'</div></div><div id="'+config.ids.awayScore+'" style="font-weight:800">‚Äî</div></div>'+
      '<div class="teamline" style="border-left:6px solid '+(g.home.color?('#'+g.home.color):'#2a3643')+'"><div style="display:flex;gap:10px;align-items:center">'+(g.home.logo?'<img src="'+g.home.logo+'">':'')+'<div style="font-weight:700">'+g.home.name+'</div></div><div id="'+config.ids.homeScore+'" style="font-weight:800">‚Äî</div></div>';
    showTop(true); showSplash(false); showTracker(true); $(config.ids.backBtn).style.display='inline-block';
    if(state.pollTimer) clearInterval(state.pollTimer);
    refreshOnce(); state.pollTimer=setInterval(()=>{ if(visible()) refreshOnce(); },POLL_MS);
    fillJump(); updateHeaderPicksLeft();
  }

  function updateHeaderPicksLeft(){
    (async()=>{
      const u=(await sb.auth.getUser()).data.user; if(!u){ N.picksLeft.textContent='Sign in to pick games'; return; }
      const { data } = await sb.from('picks').select('id').eq('user_id',u.id).eq('league',config.prefix).eq('week_key',WK);
      const left=Math.max(PICKS_REQUIRED-(data?.length||0),0);
      N.picksLeft.textContent=left+' pick'+(left===1?'':'s')+' left this week';
    })();
  }

  /* Load week */
  async function loadWeek(){
    N.grid.innerHTML=''; N.weekNote.textContent='Loading week‚Ä¶';
    if(state.pollTimer)clearInterval(state.pollTimer);
    if(state.lbTimer)clearInterval(state.lbTimer);
    if(state.gridTimer)clearInterval(state.gridTimer);
    state.lastScoring.clear(); state.weeklyEvents=[]; state.started=new Set();

    const range=weekDateList();
    const lists=await Promise.all(range.list.map(d=>apiScoreboard(d).catch(()=>null)));
    const seen=new Set(), base=[];
    for(var k=0;k<lists.length;k++){
      var sbx=lists[k], evs=sbx&&sbx.events?sbx.events:[];
      for(var e=0;e<evs.length;e++){
        var ev=evs[e]; if(seen.has(ev.id)) continue; seen.add(ev.id);
        var comp=ev.competitions&&ev.competitions[0]?ev.competitions[0]:{}, cs=comp.competitors||[];
        var home=null,away=null; for(var c=0;c<cs.length;c++){if(cs[c].homeAway==='home')home=cs[c]; if(cs[c].homeAway==='away')away=cs[c];}
        var stateStr=(comp.status&&comp.status.type&&comp.status.type.state)?comp.status.type.state:'pre'; if(stateStr!=='pre') state.started.add(ev.id);
        base.push({id:ev.id,start:ev.date,state:stateStr,
          home:{name:home&&home.team?(home.team.shortDisplayName||home.team.displayName):'Home',id:home&&home.team?home.team.id:null,abbr:home&&home.team?(home.team.abbreviation||''):'',logo:config.logo(home&&home.team?home.team:null),color:home&&home.team&&home.team.color?home.team.color:null},
          away:{name:away&&away.team?(away.team.shortDisplayName||away.team.displayName):'Away',id:away&&away.team?away.team.id:null,abbr:away&&away.team?(away.team.abbreviation||''):'',logo:config.logo(away&&away.team?away.team:null),color:away&&away.team&&away.team.color?away.team.color:null}
        });
      }
    }
    base.sort((a,b)=>new Date(a.start)-new Date(b.start)); state.weeklyEvents=base;
    N.gridNote.textContent='Showing '+config.label+' games '+range.start+' ‚Üí '+range.end+' (Tue‚ÜíMon '+range.pretty+').';
    N.weekNote.textContent=base.length+' games';
    renderGrid(base); fillJump(); updateHeaderPicksLeft();

    startGridPolling(); refreshLB();
    if(state.lbTimer)clearInterval(state.lbTimer);
    state.lbTimer=setInterval(()=>{ if(visible()) refreshLB(); }, LB_POLL_MS);
  }

  async function refreshGridScores(){
    for(var i=0;i<state.weeklyEvents.length;i++){
      var r=await computeRow(state.weeklyEvents[i].id); if(!r) continue;
      var sc=$(config.prefix+'-scr-'+r.id), st=$(config.prefix+'-st-'+r.id),
          a=$(config.prefix+'-a-'+r.id), h=$(config.prefix+'-h-'+r.id);
      if(sc) sc.textContent=r.awayPts+'‚Äì'+r.homePts;
      if(st) st.textContent=r.status||'‚Äî';
      if(a) a.textContent=r.awayPts;
      if(h) h.textContent=r.homePts;
    }
  }
  function startGridPolling(){ refreshGridScores(); if(state.gridTimer)clearInterval(state.gridTimer); state.gridTimer=setInterval(refreshGridScores, GRID_POLL_MS); }

  /* STATS + SCORING (same as before, reliable) */
  function sumStatsFromSummary(summary){
    var totals={yards:0,firstDowns:0,tfl:0,sacks:0,thirdMade:0,thirdAtt:0,fourthMade:0,fourthAtt:0,safeties:0};
    var teams=summary&&summary.boxscore&&summary.boxscore.teams?summary.boxscore.teams:[];
    function pick(arr,name){for(var i=0;i<arr.length;i++){if(arr[i].name===name||arr[i].abbreviation===name)return arr[i];}return null;}
    for(var t=0;t<teams.length;t++){
      var st=teams[t].statistics||[], ry=pick(st,'rushingYards'), py=pick(st,'netPassingYards');
      var ryv=ry?Number(ry.value||ry.displayValue||0):0, pyv=py?Number(py.value||py.displayValue||0):0;
      totals.yards+=(isNaN(ryv)?0:ryv)+(isNaN(pyv)?0:pyv);
      var fd=pick(st,'firstDowns'); totals.firstDowns+=fd?Number(fd.value||fd.displayValue||0):0;
      var sa=pick(st,'sacks'); var sval=0; if(sa){var dv=String(sa.displayValue||'').split('-')[0]; sval=sa.value?Number(sa.value):Number(dv); if(isNaN(sval))sval=0;} totals.sacks+=sval;
      var tfl=pick(st,'tacklesForLoss'); totals.tfl+=tfl?Number(tfl.value||tfl.displayValue||0):0;
      var th=pick(st,'thirdDownEff'), thv=th?String(th.displayValue||'0-0').split('-'):['0','0']; totals.thirdMade+=Number(thv[0]||0); totals.thirdAtt+=Number(thv[1]||0);
      var fh=pick(st,'fourthDownEff'), fhv=fh?String(fh.displayValue||'0-0').split('-'):['0','0']; totals.fourthMade+=Number(fhv[0]||0); totals.fourthAtt+=Number(fhv[1]||0);
      var saf=pick(st,'safeties'); totals.safeties+=saf?Number(saf.value||saf.displayValue||0):0;
    }
    return totals;
  }
  function parsePBP(pbp){var plays=[];try{var gp=pbp&&pbp.gamepackageJSON?pbp.gamepackageJSON:null; var prev=gp&&gp.drives&&gp.drives.previous?gp.drives.previous:null; var curr=gp&&gp.drives&&gp.drives.current?gp.drives.current:null; function add(arr){if(Array.isArray(arr)){for(var i=0;i<arr.length;i++){if(Array.isArray(arr[i].plays))plays=plays.concat(arr[i].plays);}}} add(prev); add(curr);}catch(e){} return plays;}
  function calcFantasyFrom(summary,box,pbp){
    var comp=summary&&summary.header&&summary.header.competitions&&summary.header.competitions[0]?summary.header.competitions[0]:{}, status=comp.status||{}, cs=comp.competitors||[];
    var h=null,a=null; for(var i=0;i<cs.length;i++){if(cs[i].homeAway==='home')h=cs[i]; if(cs[i].homeAway==='away')a=cs[i];}
    var homePts=Number(h&&typeof h.score!=='undefined'?h.score:0), awayPts=Number(a&&typeof a.score!=='undefined'?a.score:0);

    var totals=sumStatsFromSummary(summary);
    var stopsEff=(totals.thirdAtt-totals.thirdMade)+(totals.fourthAtt-totals.fourthMade);

    var TD=0,FG=0,XP=0,TWO=0,stReturnTD=0,blocks=0,defTdBonus=0,safeties=(totals.safeties||0);
    var scoringPlays=summary&&summary.scoringPlays?summary.scoringPlays:[];
    for(var s=0;s<scoringPlays.length;s++){
      var sp=scoringPlays[s], d=String(sp.text||sp.description||'').toLowerCase(), t=String((sp.type&&sp.type.text)||sp.scoringType||'').toLowerCase();
      if(t.includes('touchdown')||d.includes('touchdown')){TD++; if(d.includes('punt return')||d.includes('kickoff return')||d.includes('kick return'))stReturnTD++; if(d.includes('interception return')||d.includes('fumble return')||d.includes('blocked punt')||d.includes('blocked kick')||d.includes('fumble recovered in end zone'))defTdBonus++; if(d.includes('safety'))safeties++;}
      else if(t.includes('field goal')||d.includes('field goal')){FG++;}
      else if(t.includes('extra point')||d.includes('extra point is good')){XP++;}
      else if(t.includes('two-point')||d.includes('two-point')){ if(d.includes('successful')||d.includes('is good')||d.includes('good')) TWO++; }
      if(d.includes('blocked')) blocks++;
    }

    var plays=parsePBP(pbp); var sacksP=0,tflP=0,stopsP=0,fdP=0,intP=0,frP=0,defTDP=0,stTDP=stReturnTD,safetyP=0,blockP=blocks,xpP=0,twoP=0;
    for(var p=0;p<plays.length;p++){
      var txt=String(plays[p].text||'').toLowerCase();
      if(txt.includes('sacked'))sacksP++;
      if(txt.includes('tackle for loss'))tflP++;
      var dn=plays[p].down, gotFirst=txt.includes('first down')||/1st and/i.test(txt), tod=txt.includes('turnover on downs'), punt=txt.startsWith('punt'), fg=(txt.includes('field goal')&&(txt.includes('is good')||txt.includes('missed')||txt.includes('blocked')));
      if((dn===3||dn===4)&&!gotFirst&&(tod||punt||fg))stopsP++;
      if(txt.includes('first down'))fdP++;
      if(txt.includes('intercepted')){intP++; if(txt.includes('for a touchdown'))defTDP++;}
      if(txt.includes('fumble')){if(txt.includes('recovered'))frP++; if(txt.includes('for a touchdown')||txt.includes('recovered in end zone'))defTDP++;}
      if((txt.includes('punt')||txt.includes('kickoff')||txt.includes('kick return'))&&txt.includes('returns')&&txt.includes('for a touchdown'))stTDP++;
      if(txt.includes('safety'))safetyP++;
      if(txt.includes('blocked punt')||txt.includes('blocked field goal')||(txt.includes('blocked')&&txt.includes('kick')))blockP++;
      if(txt.includes('extra point')&&(txt.includes('is good')||txt.includes('good')))xpP++;
      if(txt.includes('two-point')&&(txt.includes('successful')||txt.includes('good')))twoP++;
    }
    if(!totals.sacks || totals.sacks<sacksP) totals.sacks=sacksP;
    if(!totals.tfl   || totals.tfl<tflP)     totals.tfl=tflP;
    if(!totals.firstDowns) totals.firstDowns=fdP;

    var stops=Math.max(stopsEff,stopsP), XPf=Math.max(XP,xpP), TWOf=Math.max(TWO,twoP), stTDB=Math.max(stReturnTD,stTDP), safF=Math.max(safeties,safetyP,totals.safeties||0), blockF=Math.max(blocks,blockP);
    var offense=TD*W.TD+FG*W.FG+XPf*W.XP+TWOf*W.TWO+totals.yards*W.YARD+totals.firstDowns*W.FIRST_DOWN;
    var defense=totals.sacks*W.SACK+totals.tfl*W.TFL+intP*W.INT+frP*W.FR+defTdBonus*W.DEF_TD_BONUS+safF*W.SAFETY+stops*W.STOP+stTDB*W.ST_RETURN_TD+blockF*W.BLOCK;

    var isFinal=(status&&status.type&&(status.type.state==='post'||status.type.completed===true));
    var margin=Math.abs(homePts-awayPts), closeBonus=(isFinal&&margin<=7)?W.CLOSE_GAME:0, otBonus=((status&&status.period&&status.period>4)&&isFinal)?W.OVERTIME:0;
    var total=offense+defense+closeBonus+otBonus;

    return {total:Number(total.toFixed(2)),homePts,awayPts,statusText:(status&&status.type&&(status.type.shortDetail||status.type.description))?(status.type.shortDetail||status.type.description):'‚Äî',isFinal:isFinal};
  }
  async function computeRow(id){
    var cached=state.gameScoreCache.get(id); if(cached&&cached.isFinal) return cached;
    try{
      var summary=await apiSummary(id), box=null, pbp=null;
      // Box & PBP provide extra stats; fetch in parallel but tolerate failure for speed
      [box,pbp]=await Promise.all([
        safeFetch(config.endpoints.box+id).catch(()=>null),
        safeFetch(config.endpoints.pbp+id).catch(()=>null)
      ]);
      var comp=summary&&summary.header&&summary.header.competitions&&summary.header.competitions[0]?summary.header.competitions[0]:{}, cs=comp.competitors||[];
      var h=null,a=null; for(var i=0;i<cs.length;i++){if(cs[i].homeAway==='home')h=cs[i]; if(cs[i].homeAway==='away')a=cs[i];}
      var s=calcFantasyFrom(summary,box,pbp);
      var row={id,awayName:a&&a.team?(a.team.shortDisplayName||a.team.displayName):'Away',homeName:h&&h.team?(h.team.shortDisplayName||h.team.displayName):'Home',
               awayLogo:config.logo(a&&a.team?a.team:null),homeLogo:config.logo(h&&h.team?h.team:null),
               awayPts:s.awayPts,homePts:s.homePts,score:s.total,status:s.statusText,final:s.isFinal};
      if(row.final) state.gameScoreCache.set(id,row);
      return row;
    }catch(e){return null;}
  }

  /* Leaderboard (games) */
  function renderLB(){N.lb.innerHTML=''; var rows=state.showAll?state.lbRows:state.lbRows.slice(0,10); if(rows.length===0){N.lb.innerHTML='<div class="small">‚Äî</div>';return;}
    for(var i=0;i<rows.length;i++){var r=rows[i],div=document.createElement('div');div.className='lbRow';
      div.innerHTML='<div class="lbTeam">'+(r.awayLogo?'<img src="'+r.awayLogo+'">':'')+'<span class="lbName">'+r.awayName+'</span><span class="scoreTag">'+r.awayPts+
        '</span><span class="small" style="margin:0 6px;opacity:.8">at</span>'+(r.homeLogo?'<img src="'+r.homeLogo+'">':'')+'<span class="lbName">'+r.homeName+'</span><span class="scoreTag">'+r.homePts+
        '</span></div><div class="lbPts">'+r.score.toFixed(2)+'</div><div class="lbMeta">'+r.status+'</div>';
      (function(idCopy){ div.addEventListener('click',function(){ var g=state.weeklyEvents.find(x=>x.id===idCopy); if(g) openGame(g); }); })(r.id);
      N.lb.appendChild(div);
    }
    N.toggleAll.textContent=state.showAll?'Show top 10':'Show all';
    N.toggleAll.setAttribute('aria-expanded',state.showAll?'true':'false');
  }
  N.toggleAll.addEventListener('click',()=>{state.showAll=!state.showAll;renderLB();});
  async function refreshLB(){var rows=[];for(var i=0;i<state.weeklyEvents.length;i++){var r=await computeRow(state.weeklyEvents[i].id); if(r) rows.push(r);} rows.sort((a,b)=>b.score-a.score); state.lbRows=rows; renderLB();}

  /* Live view refresh */
  async function refreshOnce(){
    if(!state.selected)return;
    try{
      var id=state.selected.id, summary=await safeFetch(config.endpoints.summary+id).catch(()=>null), pbp=await safeFetch(config.endpoints.pbp+id).catch(()=>null);
      var comp=summary&&summary.header&&summary.header.competitions&&summary.header.competitions[0]?summary.header.competitions[0]:{}, status=comp.status||{}, cs=comp.competitors||[];
      var h=null,a=null; for(var i=0;i<cs.length;i++){if(cs[i].homeAway==='home')h=cs[i]; if(cs[i].homeAway==='away')a=cs[i];}
      $(config.ids.homeScore).textContent=String(h&&typeof h.score!=='undefined'?h.score:0);
      $(config.ids.awayScore).textContent=String(a&&typeof a.score!=='undefined'?a.score:0);
      N.clock.textContent=status&&status.displayClock?status.displayClock:'‚Äî'; N.q.textContent=(status&&typeof status.period!=='undefined')?String(status.period):'‚Äî';
      N.state.textContent=(status&&status.type&&(status.type.description||status.type.shortDetail))?(status.type.description||status.type.shortDetail):'‚Äî';

      var s=calcFantasyFrom(summary,null,pbp);
      N.fscore.textContent=s.total.toFixed(2);
      N.flow.textContent='Bonuses: '+((s.isFinal&&Math.abs((Number(h&&h.score||0))-(Number(a&&a.score||0)))<=7)?'Close (+10)':'‚Äî')+' ¬∑ '+((status&&status.period&&status.period>4&&s.isFinal)?'OT (+15)':'‚Äî');

      var sp=summary&&summary.scoringPlays?summary.scoringPlays:[], newLines=[];
      for(var i=0;i<sp.length;i++){var idp=sp[i].id;if(!state.lastScoring.has(idp)){var t=(sp[i].clock&&sp[i].clock.displayValue)?sp[i].clock.displayValue:'', q=(sp[i].period&&sp[i].period.number)?('Q'+sp[i].period.number):'', d=sp[i].text||sp[i].description||''; newLines.push('['+q+' '+t+'] '+d);}}
      for(var k=newLines.length-1;k>=0;k--){var d=document.createElement('div');d.textContent=newLines[k]; N.log.prepend(d);}
      for(var j=0;j<sp.length;j++) state.lastScoring.add(sp[j].id);

      renderMyPicks(); // keep ‚ÄúMy Picks‚Äù line items fresh
      renderMyTab();
    }catch(e){}
  }

  /* Players leaderboards */
  async function displayNameMap(){const {data}=await sb.from('players').select('*'); var m={}; if(data){for(var i=0;i<data.length;i++)m[data[i].user_id]=data[i].display_name;} return m;}
  async function fetchWeekPicks(){const {data}=await sb.from('picks').select('user_id,game_id').eq('league',config.prefix).eq('week_key',WK); return data||[];}
  async function totalScoreForGame(gid){var r=await computeRow(gid); return r?(r.score||0):0;}

  async function weeklyTotalsByUser(){var picks=await fetchWeekPicks(), tot={}; for(var i=0;i<picks.length;i++){var r=picks[i]; tot[r.user_id]=tot[r.user_id]||0; tot[r.user_id]+=await totalScoreForGame(r.game_id);} return tot;}
  async function renderPlayersLB(){
    var totals=await weeklyTotalsByUser(), names=await displayNameMap(), rows=[];
    Object.keys(totals).forEach(uid=>rows.push({name:names[uid]||uid.slice(0,8),total:totals[uid]}));
    rows.sort((a,b)=>b.total-a.total); N.pLB.innerHTML=''; if(rows.length===0){N.pLB.innerHTML='<div class="small">No picks this week.</div>';return;}
    for(var i=0;i<rows.length;i++){var r=rows[i], div=document.createElement('div'); div.className='lbRow'; div.innerHTML='<div class="lbTeam"><span class="lbName">'+r.name+'</span></div><div class="lbPts">'+r.total.toFixed(2)+'</div><div class="lbMeta">Weekly</div>'; N.pLB.appendChild(div);}
  }
  async function seasonTotals(){
    var cur=WK, {data}=await sb.from('picks').select('user_id,week_key,game_id').eq('league',config.prefix);
    var byWeek={}, totals={};
    for(var i=0;i<(data||[]).length;i++){var r=data[i]; if(r.week_key>=cur) continue; (byWeek[r.week_key]??=( {} )); (byWeek[r.week_key][r.user_id]??=( [] )).push(r.game_id);}
    var weeks=Object.keys(byWeek).sort(); for(var w=0; w<weeks.length; w++){var wk=weeks[w], users=Object.keys(byWeek[wk]), rows=[];
      for(var u=0; u<users.length; u++){var uid=users[u], sum=0, gids=byWeek[wk][uid]; for(var g=0; g<gids.length; g++) sum+=await totalScoreForGame(gids[g]); rows.push({uid,sum});}
      rows.sort((a,b)=>b.sum-a.sum); for(var r=0;r<rows.length;r++) totals[rows[r].uid]=(totals[rows[r].uid]||0)+Math.max(10-r,0);
    }
    return totals;
  }
  async function renderSeasonLB(){
    var totals=await seasonTotals(), names=await displayNameMap(), rows=[];
    Object.keys(totals).forEach(uid=>rows.push({name:names[uid]||uid.slice(0,8), total:totals[uid]}));
    rows.sort((a,b)=>b.total-a.total); N.pSeason.innerHTML=''; if(rows.length===0){N.pSeason.innerHTML='<div class="small">No season data yet.</div>';return;}
    for(var i=0;i<rows.length;i++){var r=rows[i], div=document.createElement('div'); div.className='lbRow'; div.innerHTML='<div class="lbTeam"><span class="lbName">'+r.name+'</span></div><div class="lbPts">'+r.total+'</div><div class="lbMeta">Season</div>'; N.pSeason.appendChild(div);}
  }

  /* My Picks (side panel in league sections) */
  async function myPicksRows(league){
    const u=(await sb.auth.getUser()).data.user; if(!u) return [];
    const {data}=await sb.from('picks').select('game_id').eq('user_id',u.id).eq('league',league||config.prefix).eq('week_key',WK);
    return data||[];
  }
  async function renderMyPicks(){
    // Render into league's right column when present (NFL/NCAA live page has no right column now; main My Picks tab handles it)
  }

  /* Boot */
  async function boot(){ await loadWeek(); setInterval(()=>{ if(visible()) renderPlayersLB(); }, LB_POLL_MS); setInterval(()=>{ if(visible()) renderSeasonLB(); }, LB_POLL_MS*2); }
  return{
    boot:boot,
    computeRow:computeRow,
    getWeek:()=>state.weeklyEvents,
    openById:(id)=>{var g=state.weeklyEvents.find(x=>x.id===id); if(g) openGame(g);},
    refreshBoards:async()=>{ await renderPlayersLB(); await renderSeasonLB(); }
  };
}

/* ============== BUILD LEAGUES ============== */
var NFL=(function(){return createLeague({
  sectionId:'sec-nfl', prefix:'nfl', label:'NFL', logo:cdnNFL,
  ids:{awayScore:'awayScoreNFL',homeScore:'homeScoreNFL',backBtn:'nfl-backBtn'},
  nodes:{
    top:$('nfl-top'), splash:$('nfl-splash'), tracker:$('nfl-tracker'),
    liveHeader:$('nfl-liveHeader'), teamSide:$('nfl-teamSide'),
    addPickBtn:$('nfl-addPickBtn'), picksLeft:$('nfl-picksLeft'),
    jump:$('nfl-jump'), jumpBtn:$('nfl-jumpBtn'),
    fscore:$('nfl-fscore'), flow:$('nfl-flow'),
    clock:$('nfl-clock'), q:$('nfl-q'), state:$('nfl-state'),
    weekNote:$('nfl-weekNote'), gridNote:$('nfl-gridNote'), grid:$('nfl-grid'),
    lb:$('nfl-lb'), toggleAll:$('nfl-toggleAll'),
    pLB:document.createElement('div'), pSeason:document.createElement('div'),
    log:$('nfl-log')
  },
  endpoints:{
    scoreboard:'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates=',
    summary:'https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=',
    box:'https://cdn.espn.com/core/nfl/boxscore?xhr=1&gameId=',
    pbp:'https://cdn.espn.com/core/nfl/playbyplay?xhr=1&gameId='
  }
});})();

var NCAAF=(function(){return createLeague({
  sectionId:'sec-ncaaf', prefix:'ncaaf', label:'NCAA FBS', logo:cdnNCAAF,
  ids:{awayScore:'awayScoreNCAAF',homeScore:'homeScoreNCAAF',backBtn:'ncaaf-backBtn'},
  nodes:{
    top:$('ncaaf-top'), splash:$('ncaaf-splash'), tracker:$('ncaaf-tracker'),
    liveHeader:$('ncaaf-liveHeader'), teamSide:$('ncaaf-teamSide'),
    addPickBtn:$('ncaaf-addPickBtn'), picksLeft:$('ncaaf-picksLeft'),
    jump:$('ncaaf-jump'), jumpBtn:$('ncaaf-jumpBtn'),
    fscore:$('ncaaf-fscore'), flow:$('ncaaf-flow'),
    clock:$('ncaaf-clock'), q:$('ncaaf-q'), state:$('ncaaf-state'),
    weekNote:$('ncaaf-weekNote'), gridNote:$('ncaaf-gridNote'), grid:$('ncaaf-grid'),
    lb:$('ncaaf-lb'), toggleAll:$('ncaaf-toggleAll'),
    pLB:document.createElement('div'), pSeason:document.createElement('div'),
    log:$('ncaaf-log')
  },
  endpoints:{
    scoreboard:'https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?dates=',
    summary:'https://site.api.espn.com/apis/site/v2/sports/football/college-football/summary?event=',
    box:'https://cdn.espn.com/core/college-football/boxscore?xhr=1&gameId=',
    pbp:'https://cdn.espn.com/core/college-football/playbyplay?xhr=1&gameId='
  }
});})();

/* ======= Leaderboards tab glue (both leagues) ======= */
let LB_NFL_SHOW_ALL=false, LB_NCAA_SHOW_ALL=false;
$('lbNFLtoggle').addEventListener('click',()=>{ LB_NFL_SHOW_ALL=!LB_NFL_SHOW_ALL; renderLBtab(); });
$('lbNCAAtoggle').addEventListener('click',()=>{ LB_NCAA_SHOW_ALL=!LB_NCAA_SHOW_ALL; renderLBtab(); });

async function renderLBtab(){
  // games leaderboard both leagues
  const listNFL = NFL.getWeek();
  const listNCAA = NCAAF.getWeek();
  async function rowsFor(list, league){ const out=[]; for(let g of list){ const r=await (league==='nfl'?NFL:NCAAF).computeRow(g.id); if(r) out.push(r);} out.sort((a,b)=>b.score-a.score); return out; }
  const [rowsNFL, rowsNCAA] = await Promise.all([rowsFor(listNFL,'nfl'), rowsFor(listNCAA,'ncaaf')]);

  function fill(containerId, rows, showAll){
    const wrap=$(containerId); wrap.innerHTML='';
    const display= showAll ? rows : rows.slice(0,10);
    for(const r of display){
      const div=document.createElement('div'); div.className='lbRow';
      div.innerHTML='<div class="lbTeam">'+(r.awayLogo?'<img src="'+r.awayLogo+'">':'')+'<span class="lbName">'+r.awayName+
        '</span><span class="scoreTag">'+r.awayPts+'</span><span class="small" style="margin:0 6px;opacity:.8">at</span>'+
        (r.homeLogo?'<img src="'+r.homeLogo+'">':'')+'<span class="lbName">'+r.homeName+'</span><span class="scoreTag">'+r.homePts+
        '</span></div><div class="lbPts">'+r.score.toFixed(2)+'</div><div class="lbMeta">'+r.status+'</div>';
      div.addEventListener('click',()=>{ if(containerId==='lbNFL') { selectTab('nfl'); NFL.openById(r.id); } else { selectTab('ncaaf'); NCAAF.openById(r.id); } });
      wrap.appendChild(div);
    }
    const btn = (containerId==='lbNFL')?$('lbNFLtoggle'):$('lbNCAAtoggle');
    btn.textContent = showAll? 'Show top 10' : 'Show all';
    btn.setAttribute('aria-expanded', showAll?'true':'false');
  }
  fill('lbNFL', rowsNFL, LB_NFL_SHOW_ALL);
  fill('lbNCAA', rowsNCAA, LB_NCAA_SHOW_ALL);

  // player boards
  await NFL.refreshBoards(); await NCAAF.refreshBoards();
  // Put their latest HTML into Leaderboards tab containers
  $('pNFLweek').innerHTML = NFL.nodes.pLB.innerHTML;
  $('pNCAAweek').innerHTML = NCAAF.nodes.pLB.innerHTML;
  $('pNFLseason').innerHTML = NFL.nodes.pSeason.innerHTML;
  $('pNCAAseason').innerHTML = NCAAF.nodes.pSeason.innerHTML;
}

/* ======= My Picks tab (both leagues) ======= */
async function renderMyTab(){
  const wrap=$('mine-list');
  const u=(await sb.auth.getUser()).data.user;
  if(!u){ wrap.innerHTML='<div class="small">Sign in to see your picks.</div>'; return; }
  const WK = weekKey();
  const [nfl,ncaa] = await Promise.all([
    sb.from('picks').select('game_id').eq('user_id',u.id).eq('league','nfl').eq('week_key',WK),
    sb.from('picks').select('game_id').eq('user_id',u.id).eq('league','ncaaf').eq('week_key',WK),
  ]);
  const rows=[...(nfl.data||[]).map(x=>({league:'nfl',game_id:x.game_id})), ...(ncaa.data||[]).map(x=>({league:'ncaaf',game_id:x.game_id}))];
  if(rows.length===0){ wrap.innerHTML='<div class="small">No picks yet. Open a game in NFL or NCAA and click ‚ÄúAdd to my picks‚Äù.</div>'; return; }
  wrap.innerHTML='';
  for(const r of rows){
    const row = await (r.league==='nfl'?NFL:NCAAF).computeRow(r.game_id); if(!row) continue;
    const div=document.createElement('div'); div.className='rowx';
    div.innerHTML='<div class="left">'+(row.awayLogo?'<img src="'+row.awayLogo+'">':'')+'<span>'+row.awayName+' @ '+row.homeName+' <span class="small" style="margin-left:6px;opacity:.7">['+(r.league.toUpperCase())+']</span></span></div>'+
                  '<div>'+row.awayPts+'‚Äì'+row.homePts+'</div>'+
                  '<div class="lbPts" style="min-width:72px;text-align:right">'+row.score.toFixed(2)+'</div>'+
                  '<button class="btn small">Open</button>';
    div.querySelector('button').addEventListener('click',()=>{ selectTab(r.league==='nfl'?'nfl':'ncaaf'); (r.league==='nfl'?NFL:NCAAF).openById(row.id); });
    wrap.appendChild(div);
  }
}

/* Tabs */
var tabNFL=$('tab-nfl'), tabNCAAF=$('tab-ncaaf'), tabMine=$('tab-mine'), tabLB=$('tab-lb');
var secNFL=$('sec-nfl'), secNCAAF=$('sec-ncaaf'), secMine=$('sec-mine'), secLB=$('sec-lb');
function selectTab(which){
  const map={nfl:[tabNFL,secNFL], ncaaf:[tabNCAAF,secNCAAF], mine:[tabMine,secMine], lb:[tabLB,secLB]};
  for(const k of Object.keys(map)){ map[k][0].setAttribute('aria-selected', k===which?'true':'false'); map[k][1].classList.toggle('active', k===which); }
  if(which==='lb') renderLBtab();
  if(which==='mine') renderMyTab();
}
tabNFL.addEventListener('click',()=>selectTab('nfl'));
tabNCAAF.addEventListener('click',()=>selectTab('ncaaf'));
tabMine.addEventListener('click',()=>selectTab('mine'));
tabLB.addEventListener('click',()=>selectTab('lb'));

/* One-time boot + safety boot */
var _booted=false;
async function bootOnce(){ if(_booted) return; _booted=true; await NFL.boot(); await NCAAF.boot(); renderLBtab(); renderMyTab(); }
setTimeout(()=>{ try{ bootOnce(); }catch(e){ console.error(e); } }, 1000);
</script>
</body>
</html>
