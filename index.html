<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Football Picks â€” NFL & NCAA</title>

<!-- Supabase CDN FIRST (must come before our code) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Preconnect for ESPN -->
<link rel="preconnect" href="https://site.api.espn.com">
<link rel="preconnect" href="https://a.espncdn.com">

<style>
:root{
  --bg:#0b0d10; --card:#10161e; --mut:#93a6ba; --txt:#eaf0f7;
  --br:#1c2733; --ok:#2ecc71; --warn:#ffb020; --err:#ff5b5b; --ac:#2f86ff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{position:sticky;top:0;z-index:30;background:#0e141b;border-bottom:1px solid var(--br);padding:12px 18px}
h1{margin:0;font-size:18px}.sub{color:var(--mut);font-size:13px;margin-left:6px}
main{max-width:1150px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:14px}
.sep{height:1px;background:#16202b;margin:10px 0}.small{color:var(--mut);font-size:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{background:#13202b;border:1px solid #233142;border-radius:10px;color:var(--txt);padding:8px 10px;cursor:pointer}
.btn.small{padding:6px 8px;font-size:12px}.btn[disabled]{opacity:.6;cursor:not-allowed}
input[type="email"],input[type="password"],input[type="text"]{background:#0c1218;border:1px solid #1b2733;border-radius:8px;color:var(--txt);padding:8px;width:220px}

nav.tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--br);background:#0e141b;position:sticky;top:54px;z-index:29;padding:8px 16px}
.tab{border:1px solid #233142;background:#121a22;border-radius:10px;color:var(--txt);padding:8px 12px;cursor:pointer}
.tab[aria-selected="true"]{background:#172433;border-color:#2e4a66;font-weight:700}
.section{display:none}.section.active{display:block}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.cardGame{border:1px solid #1b2633;background:#0f151d;border-radius:14px;overflow:hidden}
.band{height:6px}
.gbody{padding:12px}
.teams{display:flex;justify-content:space-between;align-items:center;gap:10px}
.t{display:flex;gap:8px;align-items:center;min-width:0}
.t img{width:26px;height:26px;border-radius:6px;border:1px solid #1d2733;background:#0d1218}
.t .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tag{border:1px solid #263241;border-radius:6px;padding:2px 6px;font-weight:700;margin-left:6px}
.rowBtns{display:flex;gap:8px;margin-top:10px}
.note{margin-top:6px;font-size:12px;color:#ffbdad}
.badge{display:inline-block;padding:3px 8px;border:1px solid #2a3949;border-radius:999px;background:#0f1822}

.myRow{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px;border:1px solid #1c2430;background:#0f151d;border-radius:10px;margin-bottom:8px}
.myLeft{display:flex;gap:8px;align-items:center;min-width:0}
.myLeft img{width:20px;height:20px;border:1px solid #1c2330;border-radius:4px;background:#0d1218}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table tr{background:#0f151d}
.table td,.table th{padding:10px;border-top:1px solid #1b2733;border-bottom:1px solid #1b2733}
.table th{color:#bcd2e6;text-align:left;border:none;padding-bottom:0;background:transparent}
.rank{width:48px;text-align:center;color:#9fb7ce}

.banner{position:sticky;top:0;z-index:50;margin:0;background:#3b0f14;border-bottom:1px solid #5a1d24;color:#ffd6d6;padding:10px 16px;font-size:13px}
#toasts{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:60}
.toast{background:#0f151d;border:1px solid #1b2a3a;border-radius:10px;padding:10px 12px;color:var(--txt);box-shadow:0 10px 20px rgba(0,0,0,.35);min-width:220px;max-width:92vw;display:flex;gap:8px}
.toast.ok{border-color:#214c34}.toast.warn{border-color:#4b3f22}.toast.err{border-color:#4b2222}
.toast .tag{font-weight:800}.toast .msg{font-size:13px}.toast button{margin-left:auto;background:transparent;border:0;color:var(--mut);cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>Football Picks <span class="sub">NFL & NCAA Â· Tueâ†’Mon Â· 3 picks / league</span></h1>
</header>

<!-- SCHEMA BANNER (appears if DB not ready) -->
<div id="schemaBanner" class="banner" style="display:none"></div>

<main>
  <!-- ACCOUNT -->
  <section class="card">
    <div class="row">
      <strong>Account</strong>
      <span id="authState" class="badge">Signed out</span>
    </div>
    <div class="sep"></div>

    <div id="authOut">
      <div class="row">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button id="btnSignUp" class="btn small">Sign up</button>
        <button id="btnSignIn" class="btn small">Sign in</button>
      </div>
      <div class="small" style="margin-top:6px">First time: confirm the email, then sign in.</div>
    </div>

    <div id="authIn" style="display:none">
      <div class="row">
        <span class="small">Signed in as <b id="who"></b></span>
        <button id="btnSignOut" class="btn small">Sign out</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <input id="displayName" type="text" placeholder="Your display name">
        <button id="btnSaveName" class="btn small">Save name</button>
        <span id="nameSaved" class="small" style="display:none">Saved âœ“</span>
      </div>
    </div>
  </section>
</main>

<!-- TABS -->
<nav class="tabs" role="tablist" aria-label="Sections">
  <button class="tab" id="tab-nfl"  role="tab" aria-controls="sec-nfl"  aria-selected="true">NFL <span id="badgeNFL" class="small"></span></button>
  <button class="tab" id="tab-ncaa" role="tab" aria-controls="sec-ncaa" aria-selected="false">NCAA <span id="badgeNCAA" class="small"></span></button>
  <button class="tab" id="tab-mine" role="tab" aria-controls="sec-mine" aria-selected="false">My Picks</button>
  <button class="tab" id="tab-boards" role="tab" aria-controls="sec-boards" aria-selected="false">Leaderboards</button>
</nav>

<!-- NFL -->
<section id="sec-nfl" class="section active" aria-labelledby="tab-nfl">
  <main>
    <section class="card">
      <div class="row">
        <strong>NFL Week</strong>
        <span id="weekNFL" class="small"></span>
        <span class="small" id="nflHint"></span>
      </div>
      <div class="sep"></div>
      <div id="gridNFL" class="grid"></div>
    </section>
  </main>
</section>

<!-- NCAA -->
<section id="sec-ncaa" class="section" aria-labelledby="tab-ncaa">
  <main>
    <section class="card">
      <div class="row">
        <strong>NCAA Week</strong>
        <span id="weekNCAA" class="small"></span>
        <span class="small" id="ncaaHint"></span>
      </div>
      <div class="sep"></div>
      <div id="gridNCAA" class="grid"></div>
    </section>
  </main>
</section>

<!-- MY PICKS -->
<section id="sec-mine" class="section" aria-labelledby="tab-mine">
  <main>
    <section class="card">
      <div class="row"><strong>My Picks â€” This Week</strong></div>
      <div class="sep"></div>
      <div id="myList"></div>
    </section>
  </main>
</section>

<!-- LEADERBOARDS -->
<section id="sec-boards" class="section" aria-labelledby="tab-boards">
  <main>
    <section class="card">
      <div class="row"><strong>Leaderboards</strong><span class="small"> Â· Live counts of picks</span></div>
      <div class="sep"></div>

      <div class="row"><b>This Week</b><span id="lbWeek" class="small" style="margin-left:6px"></span></div>
      <table class="table" id="tblWeek">
        <thead><tr><th class="rank">#</th><th>User</th><th>Display Name</th><th>Picks</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="sep"></div>

      <div class="row"><b>Season to Date (all weeks)</b></div>
      <table class="table" id="tblSeason">
        <thead><tr><th class="rank">#</th><th>User</th><th>Display Name</th><th>Total Picks</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </main>
</section>

<!-- Toasts -->
<div id="toasts"></div>

<script>
/* ========= Supabase init (YOUR KEYS) ========= */
const SB_URL  = "https://zrsqxylrcblcvtomamgd.supabase.co";
const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyc3F4eWxyY2JsY3Z0b21hbWdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNDAzOTYsImV4cCI6MjA3MjgxNjM5Nn0._H00AQ0VCLs3fkM2lKaWV-I4n9qKf51yjKmorxnonzw";
const sb = supabase.createClient(SB_URL, SB_ANON);

/* ========= helpers ========= */
const $=id=>document.getElementById(id);
function toast(kind, tag, msg, ms){const w=$('toasts');const t=document.createElement('div');t.className='toast '+(kind||'');t.innerHTML='<div class="tag">'+(tag||'')+'</div><div class="msg">'+(msg||'')+'</div><button>âœ•</button>';t.querySelector('button').onclick=()=>w.removeChild(t);w.appendChild(t);setTimeout(()=>{t.parentNode&&w.removeChild(t)},ms||3500);}
function nowEST(){return new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'}));}
function addDaysEST(d,n){const x=new Date(d.getTime());x.setDate(x.getDate()+n);return new Date(x.toLocaleString('en-US',{timeZone:'America/New_York'}));}
function fmtParts(d,opts){const p=new Intl.DateTimeFormat('en-US',opts).formatToParts(d),o={};for(const i of p){o[i.type]=i.value}return o;}
function weekKey(){const n=nowEST(),wd=n.getDay(),since=(wd-2+7)%7,tue=addDaysEST(n,-since);const hh=parseInt(new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',hour:'2-digit',hour12:false}).format(n),10);const anchor=(hh>=8||since>0)?tue:addDaysEST(tue,-7);const k=fmtParts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'});return k.year+'-'+k.month+'-'+k.day+'-Tue08ET'}
function weekRangePretty(){const n=nowEST(),wd=n.getDay(),since=(wd-2+7)%7,tue=addDaysEST(n,-since),mon=addDaysEST(tue,6),a=fmtParts(tue,{month:'2-digit',day:'2-digit'}),b=fmtParts(mon,{month:'2-digit',day:'2-digit'});return a.month+'/'+a.day+' â†’ '+b.month+'/'+b.day}
function datesThisWeek(){const n=nowEST(),wd=n.getDay(),since=(wd-2+7)%7,tue=addDaysEST(n,-since),arr=[];for(let i=0;i<7;i++){const d=addDaysEST(tue,i),p=fmtParts(d,{year:'numeric',month:'2-digit',day:'2-digit'});arr.push(p.year+p.month+p.day)}return arr;}
function guardOnce(btn){ if(btn.dataset.busy==='1') return false; btn.dataset.busy='1'; btn.disabled=true; return true; }
function release(btn){ btn.dataset.busy=''; btn.disabled=false; }

/* ========= Auth UI ========= */
const out=$('authOut'), IN=$('authIn'), stateEl=$('authState'), who=$('who'), disp=$('displayName');

$('btnSignUp').onclick=async()=>{
  const {error}=await sb.auth.signUp({email:$('email').value.trim(),password:$('password').value.trim()});
  if(error) toast('err','Sign up',error.message); else toast('ok','Check email','Then sign in.');
};
$('btnSignIn').onclick=async()=>{
  const {error}=await sb.auth.signInWithPassword({email:$('email').value.trim(),password:$('password').value.trim()});
  if(error) toast('err','Sign in',error.message); else toast('ok','Signed in','Welcome back!');
};
$('btnSignOut').onclick=async()=>{
  try{await sb.auth.signOut();}catch(e){}
  try{const ref=(SB_URL.match(/^https?:\/\/([^.]+)\.supabase\.co/)||[])[1]; if(ref) localStorage.removeItem(`sb-${ref}-auth-token`);}catch(e){}
  toast('ok','Signed out','See you soon.'); location.reload();
};
$('btnSaveName').onclick=async()=>{
  const nm=(disp.value||'').trim(); if(!nm) return toast('warn','Name','Type a name first');
  const u=(await sb.auth.getUser()).data.user; if(!u) return toast('warn','Sign in','Please sign in first');
  const up=await sb.from('players').upsert({user_id:u.id,display_name:nm},{onConflict:'user_id'});
  if(up.error){ if(up.error.code==='42P01'||up.error.code==='401'||up.error.code==='403'){ showSchemaBanner(); toast('err','DB','Run SQL shown in red banner'); return; } toast('err','Save failed',up.error.message); return; }
  $('nameSaved').style.display='inline'; setTimeout(()=>$('nameSaved').style.display='none',1200);
  toast('ok','Saved','Name updated'); refreshBadges(); renderBoards(); // show on boards quickly
};

sb.auth.onAuthStateChange(async(ev,session)=>{
  const user=session?.user;
  if(user){ out.style.display='none'; IN.style.display='block'; stateEl.textContent='Signed in'; who.textContent=user.email;
    const p=await sb.from('players').select('*').eq('user_id',user.id).limit(1); if(p.data?.length) disp.value=p.data[0].display_name;
  }else{ out.style.display='block'; IN.style.display='none'; stateEl.textContent='Signed out'; }
  refreshBadges(); renderMyPicks(); renderBoards();
});

/* ========= ESPN fetch ========= */
async function j(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
function teamLogoNFL(t){ if(t?.logos?.[0]?.href) return t.logos[0].href.replace(/^http:/,'https:'); if(t?.abbreviation) return 'https://a.espncdn.com/i/teamlogos/nfl/500/'+t.abbreviation+'.png'; return ''; }
function teamLogoNCAA(t){ if(t?.logos?.[0]?.href) return t.logos[0].href.replace(/^http:/,'https:'); if(t?.id) return 'https://a.espncdn.com/i/teamlogos/ncaa/500/'+t.id+'.png'; return ''; }

/* ========= League loaders ========= */
function cardHTML(g, prefix){
  const band='linear-gradient(90deg,'+ (g.away.color||'#223146') +' 0%,'+ (g.home.color||'#2c3950') +' 100%)';
  const k=new Date(g.start).toLocaleString([], {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'2-digit'});
  const locked = Date.now() >= new Date(g.start).getTime();
  return `
  <div class="cardGame">
    <div class="band" style="background:${band}"></div>
    <div class="gbody">
      <div class="teams">
        <div class="t">${g.away.logo?`<img src="${g.away.logo}">`:''}<div class="name">${g.away.name}</div><span class="tag" id="${prefix}-a-${g.id}">0</span></div>
        <div class="small">@</div>
        <div class="t" style="justify-content:flex-end">${g.home.logo?`<img src="${g.home.logo}">`:''}<div class="name">${g.home.name}</div><span class="tag" id="${prefix}-h-${g.id}">0</span></div>
      </div>
      <div class="small" style="margin-top:6px">Score: <span id="${prefix}-scr-${g.id}">â€”</span> Â· <span id="${prefix}-st-${g.id}">${g.state}</span> Â· Kick: ${k}</div>
      <div class="rowBtns">
        <button class="btn lockBtn" data-id="${g.id}" data-prefix="${prefix}" ${locked?'disabled':''}>ðŸ”’ Add to my picks</button>
        <button class="btn small openBtn" data-id="${g.id}" data-prefix="${prefix}">Open</button>
      </div>
      ${ locked ? `<div class="note">Locked (already started)</div>` : '' }
    </div>
  </div>`;
}

async function loadLeague(kind){
  const base = kind==='nfl'
    ? 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates='
    : 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?dates=';
  const dates = datesThisWeek();
  const all=[];
  for(const d of dates){
    try{ const r=await j(base+d); (r.events||[]).forEach(ev=>all.push(ev)); }catch(e){ console.warn(kind,'day',d,'err',e.message); }
  }
  const seen=new Set(), games=[];
  for(const ev of all){
    if(seen.has(ev.id)) continue; seen.add(ev.id);
    const c=ev.competitions?.[0]||{}, cs=c.competitors||[];
    const home=cs.find(x=>x.homeAway==='home')||{}, away=cs.find(x=>x.homeAway==='away')||{};
    games.push({
      id:ev.id, start:ev.date, state:c.status?.type?.state||'pre',
      home:{name:home.team?.shortDisplayName||home.team?.displayName||'Home', logo:(kind==='nfl'?teamLogoNFL:teamLogoNCAA)(home.team||null), color:'#'+(home.team?.color||'203040')},
      away:{name:away.team?.shortDisplayName||away.team?.displayName||'Away', logo:(kind==='nfl'?teamLogoNFL:teamLogoNCAA)(away.team||null), color:'#'+(away.team?.color||'203040')}
    });
  }
  games.sort((a,b)=>new Date(a.start)-new Date(b.start));
  return games;
}

async function renderLeague(kind){
  const grid = kind==='nfl' ? $('gridNFL') : $('gridNCAA');
  const label = kind==='nfl' ? $('weekNFL') : $('weekNCAA');
  const hint  = kind==='nfl' ? $('nflHint') : $('ncaaHint');
  label.textContent = weekKey() + ' (' + weekRangePretty() + ')';
  hint.textContent  = 'Add to pick requires sign in. Locks at kickoff.';
  const list = await loadLeague(kind);
  grid.innerHTML = list.map(g=>cardHTML(g, kind==='nfl'?'nfl':'ncaaf')).join('') || '<div class="small">No games found.</div>';

  // scores/status refresher
  const sumBase = kind==='nfl'
    ? 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event='
    : 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/summary?event=';
  async function updateOne(id){
    try{
      const s=await j(sumBase+id+'&_cbust='+Date.now());
      const comp=s?.header?.competitions?.[0]||{}, cs=comp.competitors||[];
      const h=cs.find(x=>x.homeAway==='home'), a=cs.find(x=>x.homeAway==='away');
      const hp=Number(h?.score||0), ap=Number(a?.score||0);
      const st=(comp.status?.type?.shortDetail||comp.status?.type?.description||'â€”');
      (document.getElementById((kind==='nfl'?'nfl':'ncaaf')+'-a-'+id)||{}).textContent = ap;
      (document.getElementById((kind==='nfl'?'nfl':'ncaaf')+'-h-'+id)||{}).textContent = hp;
      (document.getElementById((kind==='nfl'?'nfl':'ncaaf')+'-scr-'+id)||{}).textContent = ap+'â€“'+hp;
      (document.getElementById((kind==='nfl'?'nfl':'ncaaf')+'-st-'+id)||{}).textContent = st;
    }catch(e){}
  }
  list.forEach(g=>updateOne(g.id));
  const timerKey = kind==='nfl' ? '_tNFL' : '_tNCAA';
  if(window[timerKey]) clearInterval(window[timerKey]);
  window[timerKey] = setInterval(()=>{ list.forEach(g=>updateOne(g.id)); }, 30000);

  // store
  if(kind==='nfl') window._NFL_LIST = list; else window._NCAA_LIST = list;
}

/* ========= Picks ========= */
const PICKS_PER_LEAGUE = 3;

async function refreshBadges(){
  const u=(await sb.auth.getUser()).data.user;
  if(!u){ $('badgeNFL').textContent=''; $('badgeNCAA').textContent=''; return; }
  const WK=weekKey();
  const [n1,n2]=await Promise.all([
    sb.from('picks').select('game_id').eq('user_id',u.id).eq('league','nfl').eq('week_key',WK),
    sb.from('picks').select('game_id').eq('user_id',u.id).eq('league','ncaaf').eq('week_key',WK),
  ]);
  if(n1.error?.code==='42P01'||n2.error?.code==='42P01'||n1.error?.code==='401'||n2.error?.code==='401'){ showSchemaBanner(); return; }
  const c1=n1.data?.length||0, c2=n2.data?.length||0;
  $('badgeNFL').textContent  = (PICKS_PER_LEAGUE-c1>0)?`(${PICKS_PER_LEAGUE-c1} left)`:'(âœ“ done)';
  $('badgeNCAA').textContent = (PICKS_PER_LEAGUE-c2>0)?`(${PICKS_PER_LEAGUE-c2} left)`:'(âœ“ done)';
}

async function addPick(prefix, gameId, btn){
  const u=(await sb.auth.getUser()).data.user;
  if(!u) return toast('warn','Sign in','Sign in first');

  if(!guardOnce(btn)) return;
  try{
    const WK=weekKey();

    // lock if started
    const list = prefix==='nfl' ? (window._NFL_LIST||[]) : (window._NCAA_LIST||[]);
    const g = list.find(x=>x.id===gameId);
    if(g && Date.now() >= new Date(g.start).getTime()){
      toast('warn','Locked','Game already started'); btn.textContent='Locked'; return;
    }

    const mine = await sb.from('picks').select('game_id').eq('user_id',u.id).eq('league',prefix).eq('week_key',WK);
    if(mine.error){
      if(mine.error.code==='42P01' || mine.error.code==='401' || mine.error.code==='403'){ showSchemaBanner(); toast('err','DB not ready','Run the SQL shown in the red banner'); return; }
      toast('err','Load failed',mine.error.message); return;
    }
    if(mine.data.find(r=>r.game_id===gameId)){ btn.textContent='Added âœ“'; btn.disabled=true; return toast('warn','Already picked','You already picked this game'); }
    if(mine.data.length>=PICKS_PER_LEAGUE){ return toast('warn','Limit reached',`Max ${PICKS_PER_LEAGUE} picks in this league`); }

    const ins = await sb.from('picks').insert({user_id:u.id, league:prefix, week_key:WK, game_id:gameId});
    if(ins.error){ toast('err','Pick failed',ins.error.message); return; }
    btn.textContent='Added âœ“'; btn.disabled=true;
    toast('ok','Pick saved','Added to your picks âœ“');
    refreshBadges(); renderMyPicks(); renderBoards();
  }finally{ release(btn); }
}

/* click delegation */
document.addEventListener('click',(e)=>{
  const lock=e.target.closest('.lockBtn'); if(lock){ addPick(lock.dataset.prefix, lock.dataset.id, lock); return; }
  const open=e.target.closest('.openBtn'); if(open){ const id=open.dataset.id, lg=open.dataset.prefix; const url = lg==='nfl'
    ? ('https://www.espn.com/nfl/game/_/gameId/'+id) : ('https://www.espn.com/college-football/game/_/gameId/'+id); window.open(url,'_blank'); }
});

/* ========= My Picks ========= */
async function renderMyPicks(){
  const wrap=$('myList');
  const u=(await sb.auth.getUser()).data.user;
  if(!u){ wrap.innerHTML='<div class="small">Sign in to see your picks.</div>'; return; }
  const WK=weekKey();
  const [nfl,ncaa] = await Promise.all([
    sb.from('picks').select('game_id').eq('user_id',u.id).eq('league','nfl').eq('week_key',WK),
    sb.from('picks').select('game_id').eq('user_id',u.id).eq('league','ncaaf').eq('week_key',WK),
  ]);
  if(nfl.error?.code==='42P01'||ncaa.error?.code==='42P01'||nfl.error?.code==='401'||ncaa.error?.code==='401'){ showSchemaBanner(); wrap.innerHTML='<div class="small">Database not set up â€” see red banner above.</div>'; return; }
  const rows=[...(nfl.data||[]).map(x=>({lg:'NFL',id:x.game_id})), ...(ncaa.data||[]).map(x=>({lg:'NCAA',id:x.game_id}))];
  if(rows.length===0){ wrap.innerHTML='<div class="small">No picks yet. Add from NFL/NCAA tabs.</div>'; return; }
  wrap.innerHTML='';
  for(const r of rows){
    const url = r.lg==='NFL'
      ? 'https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event='+r.id
      : 'https://site.api.espn.com/apis/site/v2/sports/football/college-football/summary?event='+r.id;
    try{
      const s=await j(url); const comp=s?.header?.competitions?.[0]||{}, cs=comp.competitors||[];
      const h=cs.find(x=>x.homeAway==='home'), a=cs.find(x=>x.homeAway==='away');
      const hp=Number(h?.score||0), ap=Number(a?.score||0);
      const hT=h?.team, aT=a?.team;
      const logo = r.lg==='NFL'?teamLogoNFL:teamLogoNCAA;
      const div=document.createElement('div'); div.className='myRow';
      div.innerHTML = `
        <div class="myLeft">
          ${ logo(aT||null) ? `<img src="${logo(aT||null)}">` : '' }
          <span>${aT?.shortDisplayName||aT?.displayName||'Away'} @ ${hT?.shortDisplayName||hT?.displayName||'Home'} <span class="small" style="opacity:.7;margin-left:6px">[${r.lg}]</span></span>
        </div>
        <div>${ap}â€“${hp}</div>
        <div class="small">${comp.status?.type?.shortDetail||comp.status?.type?.description||'â€”'}</div>
      `;
      wrap.appendChild(div);
    }catch(e){/* ignore */ }
  }
}

/* ========= Leaderboards ========= */
async function renderBoards(){
  const WK=weekKey(); $('lbWeek').textContent='Week '+WK.split('-')[0]+' ('+weekRangePretty()+')';
  // week counts
  const week = await sb.from('picks').select('user_id').eq('week_key',WK);
  const all  = await sb.from('picks').select('user_id');
  if(week.error?.code==='42P01'||all.error?.code==='42P01'||week.error?.code==='401'||all.error?.code==='401'){ showSchemaBanner(); return; }
  const tally = (rows)=>rows.reduce((m,r)=>{m[r.user_id]=(m[r.user_id]||0)+1;return m;}, {});
  const weekCnt=tally(week.data||[]), allCnt=tally(all.data||[]);
  // join display names
  const ids=[...new Set([...Object.keys(weekCnt), ...Object.keys(allCnt)])];
  if(ids.length===0){ $('tblWeek').querySelector('tbody').innerHTML=''; $('tblSeason').querySelector('tbody').innerHTML=''; return; }
  const players = await sb.from('players').select('user_id,display_name').in('user_id',ids);
  const nameMap={}; (players.data||[]).forEach(p=>nameMap[p.user_id]=p.display_name||'â€”');

  function fill(tblId, obj){
    const rows = Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,50);
    const tb = $(tblId).querySelector('tbody'); tb.innerHTML='';
    let r=1; for(const [uid,c] of rows){
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td class="rank">${r}</td>
        <td class="small">${uid.slice(0,8)}â€¦</td>
        <td>${nameMap[uid]||'â€”'}</td>
        <td><b>${c}</b></td>`;
      tb.appendChild(tr); r++;
    }
  }
  fill('tblWeek', weekCnt);
  fill('tblSeason', allCnt);
}

/* ========= Schema help banner ========= */
function showSchemaBanner(){
  const b=$('schemaBanner'); if(b._shown) return; b._shown=true;
  b.style.display='block';
  b.innerHTML = `Your Supabase DB is missing tables/policies. In SQL Editor, run:
<pre style="white-space:pre-wrap">
begin;
create table if not exists public.players (
  user_id uuid primary key references auth.users(id) on delete cascade,
  display_name text not null,
  created_at timestamptz default now()
);
create table if not exists public.picks (
  user_id uuid not null references auth.users(id) on delete cascade,
  league text not null check (league in ('nfl','ncaaf')),
  week_key text not null,
  game_id text not null,
  created_at timestamptz default now(),
  primary key (user_id, league, week_key, game_id)
);
alter table public.players enable row level security;
alter table public.picks   enable row level security;
drop policy if exists players_sel on public.players;
drop policy if exists players_ins on public.players;
drop policy if exists players_upd on public.players;
drop policy if exists picks_sel on public.picks;
drop policy if exists picks_ins on public.picks;
drop policy if exists picks_del on public.picks;
drop policy if exists picks_upd on public.picks;
create policy players_sel on public.players for select using (true);
create policy players_ins on public.players for insert with check (auth.uid() = user_id);
create policy players_upd on public.players for update using (auth.uid() = user_id);
create policy picks_sel on public.picks for select using (true);
create policy picks_ins on public.picks for insert with check (auth.uid() = user_id);
create policy picks_del on public.picks for delete using (auth.uid() = user_id);
create policy picks_upd on public.picks for update using (auth.uid() = user_id);
commit;
</pre>`;
}

/* ========= Tabs ========= */
function selectTab(id){
  const map={nfl:['tab-nfl','sec-nfl'], ncaa:['tab-ncaa','sec-ncaa'], mine:['tab-mine','sec-mine'], boards:['tab-boards','sec-boards']};
  for(const k in map){ $(map[k][0]).setAttribute('aria-selected', k===id ? 'true':'false'); $(map[k][1]).classList.toggle('active', k===id); }
  if(id==='mine') renderMyPicks();
  if(id==='boards') renderBoards();
}
$('tab-nfl').onclick   = ()=>selectTab('nfl');
$('tab-ncaa').onclick  = ()=>selectTab('ncaa');
$('tab-mine').onclick  = ()=>selectTab('mine');
$('tab-boards').onclick= ()=>selectTab('boards');

/* ========= Boot ========= */
(async function boot(){
  $('weekNFL').textContent='Loadingâ€¦'; $('weekNCAA').textContent='Loadingâ€¦';
  try{ await renderLeague('nfl'); await renderLeague('ncaa'); }catch(e){ console.error(e); toast('err','Load failed',e.message); }
  refreshBadges(); renderMyPicks(); renderBoards();
  // auto reload when week flips
  let wk=weekKey(); setInterval(()=>{ const n=weekKey(); if(n!==wk) location.reload(); }, 60000);
})();
</script>
</body>
</html>
