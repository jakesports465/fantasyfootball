<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Football Fantasy — NFL + NCAA (Tue→Mon · 3 picks)</title>
<style>
  :root{ --bg:#0b0d10; --card:#12161b; --muted:#8ea0b3; --text:#e8eef4; --br:#1b232d; --ink:#0f1318; --accent:#2d89ff; }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:14px 18px;border-bottom:1px solid var(--br);background:#0f1318;position:sticky;top:0;z-index:20;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:13px;margin-left:6px}
  .chip{font-size:12px;border:1px solid var(--br);padding:4px 8px;border-radius:999px;background:#0d1218}
  .ok{color:#7dffa0;border-color:#214831;background:#122818}
  .bad{color:#ffb4b4;border-color:#4a1d1d;background:#201112}
  nav.tabs{display:flex;gap:8px;padding:10px 18px;background:#0f1318;border-bottom:1px solid var(--br);position:sticky;top:56px;z-index:19}
  .tab{padding:8px 12px;border:1px solid #243241;border-radius:10px;background:#111822;color:var(--text);cursor:pointer;font-size:13px}
  .tab[aria-selected="true"]{background:#162231;border-color:#31506a;font-weight:700}
  .section{display:none}
  .section.active{display:block}
  main{max-width:1160px;margin:0 auto;padding:16px 18px 46px}
  .card{background:var(--card);border:1px solid var(--br);border-radius:14px;padding:14px}
  .panel{background:#0f1318;border:1px solid var(--br);border-radius:12px;padding:12px}
  .sep{height:1px;background:var(--br);margin:12px 0}
  .small{font-size:12px;color:var(--muted)}
  .btn{background:#14202b;border:1px solid #243241;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px}
  .btn.small{padding:6px 8px;font-size:12px}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .gamesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
  .gameCard{background:#11171e;border:1px solid #1f2a36;border-radius:14px;overflow:hidden}
  .band{height:6px}
  .gameBody{padding:12px}
  .teamsRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .team{display:flex;align-items:center;gap:8px;min-width:0}
  .team img{width:22px;height:22px;border-radius:6px;border:1px solid #1e2732;background:#0f1318}
  .team .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .scoreTag{display:inline-block;margin-left:6px;padding:2px 6px;border:1px solid #26313c;border-radius:6px;font-weight:700;min-width:24px;text-align:center}
  .lockRow{display:flex;gap:8px;margin-top:10px}
  .topGrid{display:grid;grid-template-columns:1fr 240px 240px;gap:14px;align-items:start}
  @media(max-width:980px){.topGrid{grid-template-columns:1fr}}
  .teamline{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:12px;background:#0f1318;border:1px solid #1c2430}
  .teamline img{width:44px;height:44px;border-radius:8px;border:1px solid #1e2732;background:#0d1218} /* small logo on score page */
  .statusBox,.scoreBox{background:#0f1318;border:1px solid #1c2430;border-radius:12px;padding:12px}
  .scoreBox{text-align:center}
  .scoreBox .num{font-size:38px;font-weight:900}
  .log{max-height:260px;overflow:auto;background:#0f1318;border-radius:10px;padding:8px;border:1px solid #1b232d}
  .lbHeaderRow{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .lbRow{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:8px;border-radius:10px;border:1px solid #1c2430;background:#0f1318;margin-bottom:8px;cursor:pointer}
  .lbTeam{display:flex;gap:8px;align-items:center;min-width:0}
  .lbTeam img{width:18px;height:18px;border-radius:4px;border:1px solid #1c2330;background:#0d1218}
  .lbName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .lbPts{font-weight:800}
  .field{display:flex;gap:8px;align-items:center}
  input[type="email"],input[type="text"]{flex:1;background:#0b1117;border:1px solid #1b2633;border-radius:8px;color:var(--text);padding:8px}
  .pill{border:1px dashed #364353;border-radius:999px;padding:4px 10px;font-size:12px}
</style>
</head>
<body>

<header>
  <h1>Football Fantasy <span class="sub">NFL & NCAA · Tue→Mon · 3 picks</span></h1>
  <span id="sbStatus" class="chip bad">Supabase: OFF</span>
  <span id="authStatus" class="chip">Logged out</span>
  <span id="picksLeft" class="pill" title="Each league: max 3 picks per week">3 picks left</span>
</header>

<nav class="tabs" role="tablist" aria-label="Sections">
  <button class="tab" id="tab-nfl"   role="tab" aria-controls="sec-nfl"   aria-selected="true">NFL</button>
  <button class="tab" id="tab-ncaa"  role="tab" aria-controls="sec-ncaa"  aria-selected="false">NCAA (FBS)</button>
  <button class="tab" id="tab-lb"    role="tab" aria-controls="sec-lb"    aria-selected="false">Leaderboards</button>
  <span class="small" style="margin-left:auto">
    <span id="weekLabel">—</span>
  </span>
</nav>

<!-- ===== AUTH ===== -->
<main class="card" id="authCard" style="max-width:1160px;margin:16px auto;">
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <strong>Account</strong>
    <span id="acctEmail" class="small">Not signed in</span>
    <button id="btnSignOut" class="btn small" style="display:none">Sign out</button>
  </div>
  <div id="authForm" style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <input id="emailInput" type="email" placeholder="Email for sign in link" />
    <button id="btnSendLink" class="btn small">Send magic link</button>
    <input id="displayName" type="text" placeholder="Your display name (optional)" />
    <button id="btnSaveName" class="btn small">Save name</button>
    <span class="small" id="authNote" style="opacity:.85"></span>
  </div>
</main>

<!-- ===== NFL ===== -->
<section id="sec-nfl" class="section active" aria-labelledby="tab-nfl">
  <main>
    <section id="nfl-top" class="card" style="display:none">
      <div class="small" id="nfl-liveHeader">—</div>
      <div class="topGrid" style="margin-top:8px">
        <div id="nfl-teamSide"></div>
        <div class="scoreBox">
          <div class="small" style="margin-bottom:4px">Fantasy Score</div>
          <div id="nfl-fscore" class="num">—</div>
          <div id="nfl-bonuses" class="small">—</div>
        </div>
        <div class="statusBox">
          <div class="small" style="margin-bottom:4px">Game Status</div>
          <div class="small">Clock: <b id="nfl-clock">—</b></div>
          <div class="small">Quarter: <b id="nfl-q">—</b></div>
          <div class="small">State: <b id="nfl-state">—</b></div>
        </div>
      </div>
      <div class="sep"></div>
      <div>
        <button id="nfl-back" class="btn small">← Back to games</button>
        <button id="nfl-addPick" class="btn small" style="margin-left:8px">Add to my picks</button>
      </div>
      <div class="sep"></div>
      <h3 style="margin:0 0 6px 0">Recent Scoring Plays</h3>
      <div id="nfl-log" class="log"></div>
    </section>

    <section id="nfl-gridCard" class="card">
      <div class="small" id="nfl-note">Loading NFL week…</div>
      <div class="sep"></div>
      <div id="nfl-grid" class="gamesGrid"></div>
    </section>
  </main>
</section>

<!-- ===== NCAA ===== -->
<section id="sec-ncaa" class="section" aria-labelledby="tab-ncaa">
  <main>
    <section id="ncaa-top" class="card" style="display:none">
      <div class="small" id="ncaa-liveHeader">—</div>
      <div class="topGrid" style="margin-top:8px">
        <div id="ncaa-teamSide"></div>
        <div class="scoreBox">
          <div class="small" style="margin-bottom:4px">Fantasy Score</div>
          <div id="ncaa-fscore" class="num">—</div>
          <div id="ncaa-bonuses" class="small">—</div>
        </div>
        <div class="statusBox">
          <div class="small" style="margin-bottom:4px">Game Status</div>
          <div class="small">Clock: <b id="ncaa-clock">—</b></div>
          <div class="small">Quarter: <b id="ncaa-q">—</b></div>
          <div class="small">State: <b id="ncaa-state">—</b></div>
        </div>
      </div>
      <div class="sep"></div>
      <div>
        <button id="ncaa-back" class="btn small">← Back to games</button>
        <button id="ncaa-addPick" class="btn small" style="margin-left:8px">Add to my picks</button>
      </div>
      <div class="sep"></div>
      <h3 style="margin:0 0 6px 0">Recent Scoring Plays</h3>
      <div id="ncaa-log" class="log"></div>
    </section>

    <section id="ncaa-gridCard" class="card">
      <div class="small" id="ncaa-note">Loading NCAA week…</div>
      <div class="sep"></div>
      <div id="ncaa-grid" class="gamesGrid"></div>
    </section>
  </main>
</section>

<!-- ===== LEADERBOARD ===== -->
<section id="sec-lb" class="section" aria-labelledby="tab-lb">
  <main class="card">
    <div class="lbHeaderRow">
      <h2 style="margin:0">Leaderboards</h2>
      <span class="small" id="lbWeekLabel">—</span>
    </div>
    <div class="sep"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <section class="panel">
        <h3 style="margin:0 0 6px 0">NFL — This Week</h3>
        <div id="lbNFLWeek"></div>
        <div class="sep"></div>
        <h3 style="margin:0 0 6px 0">NFL — Season</h3>
        <div id="lbNFLSeason"></div>
      </section>
      <section class="panel">
        <h3 style="margin:0 0 6px 0">NCAA — This Week</h3>
        <div id="lbNCAAWeek"></div>
        <div class="sep"></div>
        <h3 style="margin:0 0 6px 0">NCAA — Season</h3>
        <div id="lbNCAASeason"></div>
      </section>
    </div>
  </main>
</section>

<!-- =========================  SCRIPT  ========================= -->
<script type="module">
/* ---------- Supabase ---------- */
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SB_URL  = "https://zrsqxylrcblcvtomamgd.supabase.co";
const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyc3F4eWxyY2JsY3Z0b21hbWdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNDAzOTYsImV4cCI6MjA3MjgxNjM5Nn0._H00AQ0VCLs3fkM2lKaWV-I4n9qKf51yjKmorxnonzw";

const sb = createClient(SB_URL, SB_ANON);
window.sb = sb; // for quick debugging

/* ---------- UI helpers ---------- */
const $ = (id)=>document.getElementById(id);
const weekLabel    = $("weekLabel");
const sbStatus     = $("sbStatus");
const authStatus   = $("authStatus");
const picksLeftUI  = $("picksLeft");

const tabs = {
  nfl:  { tab:$("tab-nfl"),  sec:$("sec-nfl") },
  ncaa: { tab:$("tab-ncaa"), sec:$("sec-ncaa") },
  lb:   { tab:$("tab-lb"),   sec:$("sec-lb") },
};
Object.keys(tabs).forEach(k=>{
  tabs[k].tab.addEventListener("click", ()=>{
    Object.keys(tabs).forEach(x=>{
      tabs[x].tab.setAttribute("aria-selected", x===k ? "true" : "false");
      tabs[x].sec.classList.toggle("active", x===k);
    });
  });
});

/* ---------- Week window (Tue→Mon) ---------- */
const TZ = "America/New_York";
function nowEST(){ return new Date(new Date().toLocaleString('en-US',{timeZone:TZ})); }
function addDaysEST(d,days){ const x=new Date(d.getTime()); x.setDate(x.getDate()+days); return new Date(x.toLocaleString('en-US',{timeZone:TZ})); }
function parts(d,opts){ const p=new Intl.DateTimeFormat('en-US',opts).formatToParts(d); const o={}; p.forEach(x=>o[x.type]=x.value); return o; }
function weekKey(){
  const n=nowEST(), wd=n.getDay(); // 0 Sun
  const daysSinceTue=(wd-2+7)%7;
  const tue=addDaysEST(n,-daysSinceTue);
  const hh=Number(parts(n,{hour:'2-digit',hour12:false}).hour);
  const anchor=(daysSinceTue>0 || hh>=8)?tue:addDaysEST(tue,-7);
  const p=parts(anchor,{year:'numeric',month:'2-digit',day:'2-digit'});
  return `${p.year}-${p.month}-${p.day}-Tue08ET`;
}
function weekDates(){
  const n=nowEST(), wd=n.getDay();
  const daysSinceTue=(wd-2+7)%7; const tue=addDaysEST(n,-daysSinceTue);
  const list=[]; for(let i=0;i<7;i++){ const d=addDaysEST(tue,i); const p=parts(d,{year:'numeric',month:'2-digit',day:'2-digit'}); list.push(`${p.year}-${p.month}-${p.day}`); }
  const sp=parts(tue,{month:'2-digit',day:'2-digit'}), ep=parts(addDaysEST(tue,6),{month:'2-digit',day:'2-digit'});
  return {list, pretty:`${sp.month}/${sp.day} → ${ep.month}/${ep.day}`, start:list[0], end:list[6]};
}
const WEEK_KEY = weekKey();
const WEEK = weekDates();
weekLabel.textContent = `Week: ${WEEK.pretty} (Tue→Mon)`;

/* ---------- Auth UI ---------- */
const authCard    = $("authCard");
const acctEmail   = $("acctEmail");
const btnSendLink = $("btnSendLink");
const btnSignOut  = $("btnSignOut");
const emailInput  = $("emailInput");
const displayName = $("displayName");
const btnSaveName = $("btnSaveName");
const authNote    = $("authNote");

btnSendLink.addEventListener("click", async ()=>{
  const email = (emailInput.value||"").trim();
  if(!email){ authNote.textContent="Enter your email first."; return; }
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href }});
  authNote.textContent = error ? ("Error: "+error.message) : "Check your inbox for the sign-in link.";
});

btnSignOut.addEventListener("click", async ()=>{
  await sb.auth.signOut();
});

btnSaveName.addEventListener("click", async ()=>{
  const name=(displayName.value||"").trim();
  const { data:{user} } = await sb.auth.getUser(); if(!user){ alert("Sign in first"); return; }
  const { error } = await sb.from("players").upsert({ user_id:user.id, display_name:name }, { onConflict:"user_id" });
  alert(error ? "Save failed" : "Name saved");
});

sb.auth.onAuthStateChange(async (evt, sess)=>{
  const on = !!sess;
  sbStatus.className = "chip " + (on ? "ok" : "bad");
  sbStatus.textContent = "Supabase: " + (on? "ON":"OFF");
  authStatus.textContent = on ? "Signed in" : "Logged out";
  acctEmail.textContent  = on ? (sess.user.email||"") : "Not signed in";
  btnSignOut.style.display = on ? "" : "none";
});

/* ---------- ESPN helpers ---------- */
function cdnNFL(t){ if(!t) return null; if(t.logos?.[0]?.href) return String(t.logos[0].href).replace(/^http:/,'https:'); if(t.abbreviation) return `https://a.espncdn.com/i/teamlogos/nfl/500/${t.abbreviation}.png`; return null; }
function cdnNCAA(t){ if(!t) return null; if(t.logos?.[0]?.href) return String(t.logos[0].href).replace(/^http:/,'https:'); if(t.id) return `https://a.espncdn.com/i/teamlogos/ncaa/500/${t.id}.png`; if(t.abbreviation) return `https://a.espncdn.com/i/teamlogos/ncaa/500/${t.abbreviation}.png`; return null; }

async function safeJson(url, retries=2){
  for(let i=0;i<=retries;i++){
    try{
      const ctl=new AbortController(); const t=setTimeout(()=>ctl.abort(), 15000);
      const r=await fetch(url,{signal:ctl.signal}); clearTimeout(t);
      if(!r.ok) throw new Error("HTTP "+r.status);
      return await r.json();
    }catch(e){ if(i===retries) throw e; await new Promise(r=>setTimeout(r, 600*(i+1))); }
  }
}

/* ---------- Fantasy math (your weights) ---------- */
const W = { TD:3, FG:2, XP:0.5, TWO:1, YARD:0.05, FIRST_DOWN:0.5, SACK:2.5, TFL:1.5, INT:5.5, FR:5, DEF_TD_BONUS:3, SAFETY:6, STOP:2, ST_RETURN_TD:8, BLOCK:5, CLOSE_GAME:10, OVERTIME:15 };

function sumStatsFromSummary(summary){
  const t={ yards:0, firstDowns:0, tfl:0, sacks:0, thirdMade:0, thirdAtt:0, fourthMade:0, fourthAtt:0, safeties:0 };
  const teams = summary?.boxscore?.teams || [];
  const f=(arr, key)=>arr.find(s=>s.name===key || s.abbreviation===key) || null;
  for(const tm of teams){
    const st = tm.statistics||[];
    const ry=f(st,'rushingYards'), py=f(st,'netPassingYards');
    const ryv = ry ? Number(ry.value || ry.displayValue || 0) : 0;
    const pyv = py ? Number(py.value || py.displayValue || 0) : 0;
    t.yards += (isNaN(ryv)?0:ryv) + (isNaN(pyv)?0:pyv);
    const fd=f(st,'firstDowns'); t.firstDowns += fd ? Number(fd.value || fd.displayValue || 0) : 0;
    const sa=f(st,'sacks'); let sval=0; if(sa){ const dv=String(sa.displayValue||'').split('-')[0]; sval = sa.value ? Number(sa.value) : Number(dv); if(isNaN(sval)) sval=0; }
    t.sacks += sval;
    const tl=f(st,'tacklesForLoss'); t.tfl += tl ? Number(tl.value || tl.displayValue || 0) : 0;
    const th=f(st,'thirdDownEff'); const thv = th ? String(th.displayValue||'0-0').split('-') : ['0','0']; t.thirdMade+=Number(thv[0]||0); t.thirdAtt+=Number(thv[1]||0);
    const fh=f(st,'fourthDownEff'); const fhv = fh ? String(fh.displayValue||'0-0').split('-') : ['0','0']; t.fourthMade+=Number(fhv[0]||0); t.fourthAtt+=Number(fhv[1]||0);
    const sf=f(st,'safeties'); t.safeties += sf ? Number(sf.value || sf.displayValue || 0) : 0;
  }
  return t;
}
function parsePBP(pbp){
  let plays=[]; try{
    const gp=pbp?.gamepackageJSON;
    const prev=gp?.drives?.previous || [];
    const curr=gp?.drives?.current || [];
    const add=(arr)=>{ if(Array.isArray(arr)){ for(const d of arr){ if(Array.isArray(d.plays)) plays = plays.concat(d.plays); } } };
    add(prev); add(curr);
  }catch(e){}
  return plays;
}
function calcFantasyFrom(summary, box, pbp){
  const comp = summary?.header?.competitions?.[0] || {};
  const status = comp.status || {};
  const teams = comp.competitors || [];
  let homeC=null, awayC=null; for(const c of teams){ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; }
  const homePts=Number(homeC?.score ?? 0), awayPts=Number(awayC?.score ?? 0);

  const totals = sumStatsFromSummary(summary);
  const stopsEff=(totals.thirdAtt - totals.thirdMade) + (totals.fourthAtt - totals.fourthMade);

  let TD=0, FG=0, XP=0, TWO=0, stReturnTD=0, blocks=0, defTdBonus=0, safeties=totals.safeties||0;
  const sps = summary?.scoringPlays || [];
  for(const sp of sps){
    const d=String(sp.text||sp.description||'').toLowerCase();
    const t=String(sp.type?.text||sp.scoringType||'').toLowerCase();
    if(t.includes('touchdown') || d.includes('touchdown')){
      TD++;
      if(d.includes('punt return') || d.includes('kickoff return') || d.includes('kick return')) stReturnTD++;
      if(d.includes('interception return') || d.includes('fumble return') || d.includes('blocked punt') || d.includes('blocked kick') || d.includes('fumble recovered in end zone')) defTdBonus++;
      if(d.includes('safety')) safeties++;
    } else if(t.includes('field goal') || d.includes('field goal')) FG++;
    else if(t.includes('extra point') || d.includes('extra point is good')) XP++;
    else if(t.includes('two-point') || d.includes('two-point')){ if(d.includes('successful') || d.includes('is good') || d.includes('good')) TWO++; }
    if(d.includes('blocked')) blocks++;
  }

  const plays = parsePBP(pbp);
  let sacksP=0,tflP=0,stopsP=0,fdP=0,intP=0,frP=0,defTDP=0,stTDP=stReturnTD,safetyP=0,blockP=blocks,xpP=0,twoP=0;
  for(const p of plays){
    const txt=String(p.text||'').toLowerCase();
    if(txt.includes('sacked')) sacksP++;
    if(txt.includes('tackle for loss')) tflP++;
    const dn=p.down;
    const gotFirst = txt.includes('first down') || /1st and/i.test(txt);
    const tod = txt.includes('turnover on downs');
    const punt = txt.startsWith('punt');
    const fg  = (txt.includes('field goal')) && (txt.includes('is good') || txt.includes('missed') || txt.includes('blocked'));
    if((dn===3 || dn===4) && !gotFirst && (tod || punt || fg)) stopsP++;
    if(txt.includes('first down')) fdP++;
    if(txt.includes('intercepted')){ intP++; if(txt.includes('for a touchdown')) defTDP++; }
    if(txt.includes('fumble')){ if(txt.includes('recovered')) frP++; if(txt.includes('for a touchdown') || txt.includes('recovered in end zone')) defTDP++; }
    if((txt.includes('punt') || txt.includes('kickoff') || txt.includes('kick return')) && txt.includes('returns') && txt.includes('for a touchdown')) stTDP++;
    if(txt.includes('safety')) safetyP++;
    if(txt.includes('blocked punt') || txt.includes('blocked field goal') || (txt.includes('blocked') && txt.includes('kick'))) blockP++;
    if(txt.includes('extra point') && (txt.includes('is good') || txt.includes('good'))) xpP++;
    if(txt.includes('two-point') && (txt.includes('successful') || txt.includes('good'))) twoP++;
  }
  if(!totals.sacks || totals.sacks<sacksP) totals.sacks=sacksP;
  if(!totals.tfl   || totals.tfl<tflP)     totals.tfl=tflP;
  if(!totals.firstDowns) totals.firstDowns=fdP;

  const stops = Math.max(stopsEff, stopsP);
  const XPf   = Math.max(XP, xpP);
  const TWOf  = Math.max(TWO, twoP);
  const stTDB = Math.max(stReturnTD, stTDP);
  const safF  = Math.max(safeties, safetyP, totals.safeties||0);
  const blockF= Math.max(blocks, blockP);

  const offense = TD*W.TD + FG*W.FG + XPf*W.XP + TWOf*W.TWO + totals.yards*W.YARD + totals.firstDowns*W.FIRST_DOWN;
  const defense = totals.sacks*W.SACK + totals.tfl*W.TFL + intP*W.INT + frP*W.FR + defTdBonus*W.DEF_TD_BONUS + safF*W.SAFETY + stops*W.STOP + stTDB*W.ST_RETURN_TD + blockF*W.BLOCK;

  const isFinal = (status?.type?.state==='post' || status?.type?.completed===true) ? true:false;
  const margin = Math.abs(homePts-awayPts);
  const closeBonus = (isFinal && margin<=7) ? W.CLOSE_GAME : 0;
  const otBonus = ((status?.period>4) && isFinal) ? W.OVERTIME : 0;
  const total = offense + defense + closeBonus + otBonus;

  return {
    total: Number(total.toFixed(2)),
    homePts, awayPts,
    statusText: (status?.type?.shortDetail || status?.type?.description || "—"),
    isFinal
  };
}

/* ---------- League builder ---------- */
function leagueFactory({ league, label, secIds, cdn, api }) {
  const state = {
    events: [],
    selected: null,
    poll: null,
    scoreCache: new Map()
  };

  const dom = {
    gridCard: $(secIds.gridCard),
    note:     $(secIds.note),
    grid:     $(secIds.grid),
    top:      $(secIds.top),
    back:     $(secIds.backBtn),
    addPick:  $(secIds.addBtn),
    live:     $(secIds.liveHeader),
    teamSide: $(secIds.teamSide),
    fscore:   $(secIds.fscore),
    bonus:    $(secIds.bonus),
    clock:    $(secIds.clock),
    q:        $(secIds.q),
    st:       $(secIds.state),
    log:      $(secIds.log)
  };

  dom.back.addEventListener("click", ()=>{ dom.top.style.display="none"; dom.gridCard.style.display="block"; state.selected=null; });

  dom.addPick.addEventListener("click", async ()=>{
    try{
      const { data:{user} } = await sb.auth.getUser();
      if(!user){ alert("Sign in first"); return; }
      if(!state.selected){ return; }
      // lock at kickoff
      const kick = new Date(state.selected.start).getTime();
      if(Date.now() >= kick){ alert("Locked (game already started)"); return; }
      const { error } = await sb.from("picks").upsert(
        { user_id:user.id, week_key:WEEK_KEY, league, game_id:String(state.selected.id) },
        { onConflict:"user_id,week_key,league,game_id" }
      );
      if(error) throw error;
      toast("Pick saved ✓");
      updatePicksLeft();
    }catch(e){ console.error(e); toast("Save failed"); }
  });

  function toast(msg){
    const t=document.createElement("div");
    t.textContent=msg;
    Object.assign(t.style,{position:"fixed",right:"16px",bottom:"16px",background:"#0f1318",border:"1px solid #264",padding:"8px 10px",borderRadius:"10px",zIndex:50});
    document.body.appendChild(t); setTimeout(()=>t.remove(), 1600);
  }

  function band(aColor, hColor){
    return `linear-gradient(90deg, ${aColor?("#"+aColor):"#1a232d"} 0%, ${hColor?("#"+hColor):"#26313c"} 100%)`;
  }

  function renderGrid(){
    dom.grid.innerHTML="";
    for(const g of state.events){
      const started = Date.now() >= new Date(g.start).getTime();
      const card = document.createElement("div");
      card.className="gameCard";
      const kick = new Date(g.start).toLocaleString([], {weekday:"short", month:"short", day:"numeric", hour:"numeric", minute:"2-digit"});
      card.innerHTML = `
        <div class="band" style="background:${band(g.away.color, g.home.color)}"></div>
        <div class="gameBody">
          <div class="teamsRow">
            <div class="team">
              ${g.away.logo?`<img src="${g.away.logo}" alt="">`:``}
              <div class="name">${g.away.name}</div>
              <span class="scoreTag" id="${league}-a-${g.id}">0</span>
            </div>
            <div class="small" style="opacity:.8">@</div>
            <div class="team" style="justify-content:flex-end">
              ${g.home.logo?`<img src="${g.home.logo}" alt="">`:``}
              <div class="name">${g.home.name}</div>
              <span class="scoreTag" id="${league}-h-${g.id}">0</span>
            </div>
          </div>
          <div class="small" style="margin-top:6px;opacity:.9">
            Score: <span id="${league}-scr-${g.id}">—</span>
            &middot; <span id="${league}-st-${g.id}">pre</span>
            &middot; Kick: ${kick}
          </div>
          <div class="lockRow">
            <button class="btn lockBtn" ${started?'disabled':''}>Add to my picks</button>
            <button class="btn small viewBtn">Open</button>
          </div>
          ${started?'<div class="small" style="color:#c78;margin-top:6px">Locked (already started)</div>':''}
        </div>
      `;
      card.querySelector(".viewBtn").addEventListener("click", ()=>openGame(g));
      card.querySelector(".lockBtn").addEventListener("click", async ()=>{
        const { data:{user} } = await sb.auth.getUser(); if(!user){ alert("Sign in first"); return; }
        if(Date.now() >= new Date(g.start).getTime()){ alert("Locked (game already started)"); return; }
        const { error } = await sb.from("picks").upsert(
          { user_id:user.id, week_key:WEEK_KEY, league, game_id:String(g.id) },
          { onConflict:"user_id,week_key,league,game_id" }
        );
        if(error){ console.error(error); toast("Save failed"); }
        else { toast("Pick saved ✓"); updatePicksLeft(); }
      });
      dom.grid.appendChild(card);
    }
  }

  async function computeRow(eventId){
    const cached = state.scoreCache.get(eventId);
    if(cached?.final) return cached;
    try{
      const summary = await safeJson(api.summary(eventId));
      const box     = await safeJson(api.box(eventId));
      const pbp     = await safeJson(api.pbp(eventId));
      const comp = summary?.header?.competitions?.[0] || {};
      let homeC=null, awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });
      const homeName = homeC?.team ? (homeC.team.shortDisplayName||homeC.team.displayName) : "Home";
      const awayName = awayC?.team ? (awayC.team.shortDisplayName||awayC.team.displayName) : "Away";
      const homeLogo = cdn(homeC?.team||null), awayLogo = cdn(awayC?.team||null);
      const sc = calcFantasyFrom(summary, box, pbp);
      const row = { id:eventId, awayName, homeName, awayLogo, homeLogo, awayPts:sc.awayPts, homePts:sc.homePts, score:sc.total, status:sc.statusText, final:sc.isFinal };
      if(row.final) state.scoreCache.set(eventId,row);
      return row;
    }catch(e){ return null; }
  }

  async function refreshGridScores(){
    for(const g of state.events){
      const r = await computeRow(g.id); if(!r) continue;
      const scEl = $(`${league}-scr-${g.id}`), stEl = $(`${league}-st-${g.id}`);
      const aEl  = $(`${league}-a-${g.id}`),  hEl  = $(`${league}-h-${g.id}`);
      if(scEl) scEl.textContent = `${r.awayPts}–${r.homePts}`;
      if(stEl) stEl.textContent = r.status||"—";
      if(aEl)  aEl.textContent  = r.awayPts;
      if(hEl)  hEl.textContent  = r.homePts;
    }
  }

  function openGame(g){
    state.selected=g;
    dom.live.textContent = `${g.away.name} @ ${g.home.name}`;
    dom.teamSide.innerHTML = `
      <div class="teamline" style="border-left:6px solid ${g.away.color?("#"+g.away.color):"#2a3643"}">
        <div style="display:flex;gap:10px;align-items:center">${g.away.logo?`<img src="${g.away.logo}" alt="">`:``}<div style="font-weight:700">${g.away.name}</div></div>
        <div id="${league}-awayScore" style="font-weight:800">—</div>
      </div>
      <div class="teamline" style="border-left:6px solid ${g.home.color?("#"+g.home.color):"#2a3643"}">
        <div style="display:flex;gap:10px;align-items:center">${g.home.logo?`<img src="${g.home.logo}" alt="">`:``}<div style="font-weight:700">${g.home.name}</div></div>
        <div id="${league}-homeScore" style="font-weight:800">—</div>
      </div>
    `;
    dom.gridCard.style.display="none";
    dom.top.style.display="block";
    updateGameOnce();
    if(state.poll) clearInterval(state.poll);
    state.poll=setInterval(updateGameOnce, 20000);
  }

  async function updateGameOnce(){
    if(!state.selected) return;
    const id = state.selected.id;
    try{
      const summary = await safeJson(api.summary(id));
      const box     = await safeJson(api.box(id));
      const pbp     = await safeJson(api.pbp(id));
      const comp = summary?.header?.competitions?.[0] || {};
      const status = comp.status || {};
      let homeC=null, awayC=null; (comp.competitors||[]).forEach(c=>{ if(c.homeAway==='home') homeC=c; if(c.homeAway==='away') awayC=c; });
      $(`${league}-homeScore`).textContent = String(homeC?.score ?? 0);
      $(`${league}-awayScore`).textContent = String(awayC?.score ?? 0);
      dom.clock.textContent = status.displayClock || "—";
      dom.q.textContent     = String(status.period ?? "—");
      dom.st.textContent    = (status.type?.description || status.type?.shortDetail || "—");

      const sc = calcFantasyFrom(summary, box, pbp);
      dom.fscore.textContent = sc.total.toFixed(2);
      const closeTxt = (sc.isFinal && Math.abs((homeC?.score??0)-(awayC?.score??0))<=7) ? 'Close (+10)' : '—';
      const otTxt = ((status.period>4) && sc.isFinal) ? 'OT (+15)' : '—';
      dom.bonus.textContent = `Bonuses: ${closeTxt} · ${otTxt}`;

      const sps = summary?.scoringPlays || [];
      dom.log.innerHTML = "";
      for(const sp of sps.slice(-10).reverse()){
        const t = (sp.clock?.displayValue||"");
        const q = (sp.period?.number ? "Q"+sp.period.number : "");
        const d = sp.text || sp.description || "";
        const div=document.createElement("div"); div.textContent=`[${q} ${t}] ${d}`;
        dom.log.appendChild(div);
      }
    }catch(e){}
  }

  async function loadWeek(){
    dom.note.textContent = `Loading ${label} games for ${WEEK.start} → ${WEEK.end} …`;
    const all=[];
    for(const d of WEEK.list){
      const sb = await safeJson(api.scoreboard(d)).catch(()=>null);
      const evs = sb?.events || [];
      for(const ev of evs){
        const comp = ev.competitions?.[0]||{};
        const cs = comp.competitors||[];
        let home=null, away=null;
        for(const c of cs){ if(c.homeAway==='home') home=c; if(c.homeAway==='away') away=c; }
        all.push({
          id: ev.id,
          start: ev.date,
          home: { name: home?.team ? (home.team.shortDisplayName||home.team.displayName) : "Home", color: home?.team?.color||null, logo: cdn(home?.team||null) },
          away: { name: away?.team ? (away.team.shortDisplayName||away.team.displayName) : "Away", color: away?.team?.color||null, logo: cdn(away?.team||null) }
        });
      }
    }
    all.sort((a,b)=> new Date(a.start)-new Date(b.start));
    state.events = all;
    dom.note.textContent = `${all.length} games`;
    renderGrid();
    refreshGridScores();
    setInterval(refreshGridScores, 30000);
  }

  return { loadWeek };
}

/* ---------- Build NFL / NCAA ---------- */
const NFL = leagueFactory({
  league:"NFL", label:"NFL",
  cdn: cdnNFL,
  secIds:{
    gridCard:"nfl-gridCard", note:"nfl-note", grid:"nfl-grid",
    top:"nfl-top", backBtn:"nfl-back", addBtn:"nfl-addPick", liveHeader:"nfl-liveHeader",
    teamSide:"nfl-teamSide", fscore:"nfl-fscore", bonus:"nfl-bonuses",
    clock:"nfl-clock", q:"nfl-q", state:"nfl-state", log:"nfl-log"
  },
  api:{
    scoreboard:(d)=>`https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates=${d.replace(/-/g,"")}`,
    summary:(id)=>`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${id}`,
    box:(id)=>`https://cdn.espn.com/core/nfl/boxscore?xhr=1&gameId=${id}`,
    pbp:(id)=>`https://cdn.espn.com/core/nfl/playbyplay?xhr=1&gameId=${id}`
  }
});
const NCAA = leagueFactory({
  league:"NCAA", label:"NCAA FBS",
  cdn: cdnNCAA,
  secIds:{
    gridCard:"ncaa-gridCard", note:"ncaa-note", grid:"ncaa-grid",
    top:"ncaa-top", backBtn:"ncaa-back", addBtn:"ncaa-addPick", liveHeader:"ncaa-liveHeader",
    teamSide:"ncaa-teamSide", fscore:"ncaa-fscore", bonus:"ncaa-bonuses",
    clock:"ncaa-clock", q:"ncaa-q", state:"ncaa-state", log:"ncaa-log"
  },
  api:{
    scoreboard:(d)=>`https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?dates=${d.replace(/-/g,"")}`,
    summary:(id)=>`https://site.api.espn.com/apis/site/v2/sports/football/college-football/summary?event=${id}`,
    box:(id)=>`https://cdn.espn.com/core/college-football/boxscore?xhr=1&gameId=${id}`,
    pbp:(id)=>`https://cdn.espn.com/core/college-football/playbyplay?xhr=1&gameId=${id}`
  }
});

/* ---------- Leaderboards ---------- */
const lbWeek = {
  NFL: $("lbNFLWeek"),
  NCAA: $("lbNCAAWeek")
};
const lbSeason = {
  NFL: $("lbNFLSeason"),
  NCAA: $("lbNCAASeason")
};
$("lbWeekLabel").textContent = `Week: ${WEEK.pretty}`;

async function picksForWeek(league){
  const { data:{user} } = await sb.auth.getUser(); // not required to aggregate, but session keeps client warm
  const { data, error } = await sb.from("picks")
    .select("user_id, game_id")
    .eq("week_key", WEEK_KEY)
    .eq("league", league);
  if(error){ console.error(error); return []; }
  return data;
}
async function allPastWeeks(){
  const { data, error } = await sb.from("picks")
    .select("user_id, week_key, league, game_id")
    .lt("week_key", WEEK_KEY);
  if(error){ console.error(error); return []; }
  return data;
}
async function displayNameFor(uid){
  const { data } = await sb.from("players").select("display_name").eq("user_id", uid).maybeSingle();
  return data?.display_name || (uid.slice(0,6)+"…");
}

async function scoreForGame(league, gid){
  // reuse same ESPN functions as leagues
  const api = league==="NFL" ? NFL : NCAA;
  const row = await (async()=>{ try{
    const s = await safeJson(api.api.summary(gid));
    const b = await safeJson(api.api.box(gid));
    const p = await safeJson(api.api.pbp(gid));
    return calcFantasyFrom(s,b,p).total || 0;
  }catch(e){ return 0; } })();
  return row;
}

async function renderWeeklyLB(league){
  const box = lbWeek[league];
  box.innerHTML = '<div class="small">Computing…</div>';
  const picks = await picksForWeek(league);
  const byUser = {};
  for(const pk of picks){ if(!byUser[pk.user_id]) byUser[pk.user_id]=[]; byUser[pk.user_id].push(pk.game_id); }
  const rows=[];
  for(const uid of Object.keys(byUser)){
    let total=0;
    for(const gid of byUser[uid]) total += await scoreForGame(league, gid);
    rows.push({ uid, total, picks: byUser[uid].length });
  }
  rows.sort((a,b)=>b.total-a.total);
  if(rows.length===0){ box.innerHTML='<div class="small">No picks yet.</div>'; return; }
  box.innerHTML="";
  for(const r of rows){
    const name = await displayNameFor(r.uid);
    const div = document.createElement("div"); div.className="lbRow";
    div.innerHTML = `<div class="lbTeam"><span class="lbName">${name}</span> <span class="small" style="margin-left:6px;opacity:.8">(${r.picks}/3)</span></div><div class="lbPts">${r.total.toFixed(2)}</div><div class="small">Weekly</div>`;
    box.appendChild(div);
  }
}

async function renderSeasonLB(league){
  const box = lbSeason[league];
  box.innerHTML = '<div class="small">Computing…</div>';
  const all = await allPastWeeks();
  // group by week -> compute weekly ranks -> award 10..0
  const perWeek = {};
  for(const row of all.filter(r=>r.league===league)){
    if(!perWeek[row.week_key]) perWeek[row.week_key]={};
    if(!perWeek[row.week_key][row.user_id]) perWeek[row.week_key][row.user_id]=[];
    perWeek[row.week_key][row.user_id].push(row.game_id);
  }
  const season = {};
  const wkeys = Object.keys(perWeek).sort();
  for(const wk of wkeys){
    const tmp=[];
    for(const uid of Object.keys(perWeek[wk])){
      let total=0; for(const gid of perWeek[wk][uid]) total+= await scoreForGame(league,gid);
      tmp.push({uid,total});
    }
    tmp.sort((a,b)=>b.total-a.total);
    tmp.forEach((r,idx)=>{ const pts=Math.max(10-idx,0); season[r.uid]=(season[r.uid]||0)+pts; });
  }
  const rows = Object.keys(season).map(uid=>({uid,total:season[uid]})).sort((a,b)=>b.total-a.total);
  if(rows.length===0){ box.innerHTML='<div class="small">No season data yet.</div>'; return; }
  box.innerHTML="";
  for(const r of rows){
    const name = await displayNameFor(r.uid);
    const div = document.createElement("div"); div.className="lbRow";
    div.innerHTML = `<div class="lbTeam"><span class="lbName">${name}</span></div><div class="lbPts">${r.total}</div><div class="small">Season</div>`;
    box.appendChild(div);
  }
}

/* ---------- Picks-left badge (per league) ---------- */
async function updatePicksLeft(){
  const { data:{user} } = await sb.auth.getUser();
  if(!user){ picksLeftUI.textContent="Sign in to pick"; return; }
  const { count: nflC }  = await sb.from("picks").select("*",{count:"exact", head:true}).eq("user_id",user.id).eq("league","NFL").eq("week_key",WEEK_KEY);
  const { count: ncaaC } = await sb.from("picks").select("*",{count:"exact", head:true}).eq("user_id",user.id).eq("league","NCAA").eq("week_key",WEEK_KEY);
  picksLeftUI.textContent = `NFL ${Math.max(3-(nflC||0),0)} left · NCAA ${Math.max(3-(ncaaC||0),0)} left`;
}

/* ---------- Boot ---------- */
(async ()=>{
  try{
    // ping
    try { await fetch(SB_URL+"/auth/v1/health"); sbStatus.className="chip ok"; sbStatus.textContent="Supabase: ON"; } catch{ /* noop */ }
    await NFL.loadWeek();
    await NCAA.loadWeek();
    await renderWeeklyLB("NFL");
    await renderWeeklyLB("NCAA");
    await renderSeasonLB("NFL");
    await renderSeasonLB("NCAA");
    await updatePicksLeft();
    // refresh leaderboards periodically
    setInterval(async ()=>{
      await renderWeeklyLB("NFL"); await renderWeeklyLB("NCAA");
      await updatePicksLeft();
    }, 60000);
  }catch(e){ console.error(e); }
})();
</script>
</body>
</html>
